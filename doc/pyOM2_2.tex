\documentclass[12pt]{article} 
\usepackage{natbib}
\usepackage{a4wide}
\usepackage{lineno}
\usepackage{cancel}

\newif\ifbuch
\global\buchtrue
\global\buchfalse

\newif\ifdetail
\global\detailfalse
%\global\detailtrue

\usepackage{color}
\usepackage[pdftex]{graphicx}
\usepackage[pdftex,colorlinks,
                citecolor=darkgreen,linkcolor=darkblue,urlcolor=darkblue]{hyperref}
\definecolor{darkgreen}{rgb}{0.1,0.4,0.1}
\definecolor{darkblue}{rgb}{0.1,0.1,0.3}

\usepackage{amssymb}

\newcommand{\beq}  { \begin{eqnarray*} }
\newcommand{\eeq}  { \end{eqnarray*}}
\newcommand{\beeq}  { \begin{eqnarray*} }
\newcommand{\eeeq}  { \end{eqnarray*}}
\newcommand{\eq }  [1]{Eq.~(\ref{#1})}  % Eq. (#1)
\newcommand{\sect}  [1]{Sec.~(\ref{#1})}  % Eq. (#1)
\newcommand{\fig}  [1]{Fig.~\ref{#1}}   % Fig. #1
\renewcommand{\v}[1]{{\mbox{\boldmath$ #1 $}}}  % Vektor durch Fettdruck
\newcommand{\m}    [1]{{\bf  #1 }}              % Matrix in sans serif
\newcommand{\gz}[1] {{{d #1} \over {dz}}}
\newcommand{\pt}[1]{{\partial_t #1}}
\newcommand{\ptt}[1]{{{\partial^2 #1} \over {\partial t^2}}}
\newcommand{\pttx}[1]{{{\partial^3 #1} \over {\partial t^2 \partial x}}}
\newcommand{\ptty}[1]{{{\partial^3 #1} \over {\partial t^2 \partial y}}}
\newcommand{\pttt}[1]{{{\partial^3 #1} \over {\partial t^3}}}
\newcommand{\ptx}[1]{{{\partial^2 #1} \over {\partial t \partial x}}}
\newcommand{\pty}[1]{{{\partial^2 #1} \over {\partial t \partial y}}}
\newcommand{\pz}[1]{{\partial_z #1}}
\newcommand{\pzz}[1]{{\partial_{zz} #1}}
\newcommand{\px}[1]{{\partial_x #1}}
\newcommand{\py}[1]{{\partial_y #1}}
\newcommand{\pxi}[1]{{\partial_i #1}}
\newcommand{\pxj}[1]{{\partial_j #1}}
\newcommand{\pxk}[1]{{\partial_k #1}}
\newcommand{\pb}[1]{{{\partial #1} \over {\partial b}}}
%\newcommand{\pxy}[1]{{{\partial^2 #1} \over {\partial x \partial y}}}
\newcommand{\pxy}[1]{\partial_{xy} #1}
\newcommand{\pyy}[1]{\partial_{yy} #1}
\newcommand{\pxx}[1]{\partial_{xx} #1}
\newcommand{\kx}{{\bf k} \times}
\newcommand{\dt}[1]{{{d #1} \over {d t}}}
\newcommand{\Dt}[1]{{{D #1} \over {D t}}}
\newcommand{\Div}[1]{ \nabla \cdot #1 }
\renewcommand{\div}[1]{ \nabla_{yz} \cdot #1 }
\newcommand{\Bar}[1]{ \overline{ #1} }
\newcommand{\rvec} [1]{
    \raisebox{-1.5ex}{$\stackrel{\textstyle #1}{\neg}$} }% rotierter Vektor
\newcommand{\nablq}   {\rvec\nabla}                    % rotated nabla operator
\newcommand{\Vec}[1]{\left(\begin{array}{c} #1 \end{array}\right) }
%\renewcommand{\mho}{\mathcal{W}}
\newcommand{\pn}[1]{{{\partial #1} \over {\partial n}}}
\newcommand{\pnn}[1]{{{\partial #1} \over {\partial m}}}
\newcommand{\ps}[1]{{{\partial #1} \over {\partial s}}}

\newcommand{\p}{{\partial}}
\newcommand{\vn}{{\v \nabla}}
\newcommand{\tl}{\tilde}
\newcommand{\lk}{\left(}
\newcommand{\rk}{\right)}

\newcommand{\pyOM}{pyOM2.2~}


\begin{document}

\thispagestyle{empty}
\begin{center}
{\Large \bf \pyOM documentation}\\*[1cm]

{\large  Carsten Eden\\*[0.5cm] 

Institut f\"ur Meereskunde, Universit\"at Hamburg, Germany}

\vspace{0.5cm}

{\large May 2017}

\vspace{1cm}

\end{center}

\centerline{\includegraphics[width=0.8\textwidth]{kelv2.png}}


\newpage

\vspace{0.5cm}

\vspace{1cm}

\tableofcontents

\newpage

\section{Summary}



\pyOM (Python Ocean Model) is a numerical circulation ocean model which was written for educational
purpose. It is  meant to be a simple and easy to use numerical
tool to configure and to integrate idealized and realistic numerical  simulations of the ocean
in Boussinesq approximation.
Non-hydrostatic situations as well as large-scale oceanic flows can be considered,
Cartesian or pseudo-spherical coordinate systems can be used. 
Several idealized experiments and examples are preconfigured and can be easily
chosen and modified using two alternative  configuration methods based on Fortran90 or Python.
Prerequisites for the installation is a Fortran 90 compiler and the Lapack library,
and for the Fortran front the NetCDF-library (since IO is realized mainly using the NetCDF format).
For the Python front end, the numerical module \verb+numpy+ is required and several
other modules can be used in addition, e.g. to provide 
 a graphical user interface. Both version are based on identical Fortran90 
 code which is fully parallelized  based on the MPI-library to enhance performance.
The code can be freely downloaded\footnote{ 



Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

This permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
} but there is usually no support provided.



\section{Installation}

 
The following installation procedure to compile \pyOM  on your system
assumes a Unix system and
that all libraries and compilers are available.
For both the Fortran and Python front ends of \pyOM you first need to follow the following steps:
%See below for necessary prerequisites in case of problems to compile.
\begin{itemize}
\item Obtain the source code as tar archive  from 

\verb+https://wiki.cen.uni-hamburg.de/ifm/TO/pyOM2+
  \item Make a new directory where the
 model code shall be placed. The directory is called \verb+dir+ hereafter.
  \item Extract the tar-archive containing \pyOM in \verb+dir+.
\end{itemize}

\subsection{Fortran front end}

The following steps are needed to use the Fortran front end of \pyOM
\begin{itemize}
\item Determine which site-specific Makefile options will be read by the compiler. Type

echo \verb+site_specific.mk_${HOSTTYPE}+ 

to see the file name that will be read and which needs to be provided.
The shell variable \verb+HOSTTYPE+ is used to determine the specific system and is 
usually set to the name of the system
you are logged on.  Note that names might differ using different shells.
Examples for supported systems are provided in \verb+dir+ and one of them should be copied to
the file  \verb+dir/site_specific.mk_${HOSTTYPE}+.
If necessarry edit the global variables in the 
file \verb+dir/site_specific.mk_${HOSTTYPE}+ to set compiler names and options and
to set directories of libraries.  See also comments further below.

\item Change directory to \verb+dir/for_config+ and type \verb+make <model>+,
   where  \verb+<model>+ is set to one of the example Fortran files in \verb+dir/for_src+
   (excluding the suffix \verb+.f90+).
  \item Run the executable \verb+<model>.x+ in \verb+dir/bin+,
  investigate the output and modify the model setup.
\end{itemize}


The platform dependent options in the file \verb+dir/site_specific.mk_${HOSTTYPE}+ contain
information about the path to netcdf library and header files in the variable
\verb+CDFFLAGS+ and information for the path to MPI library and header
in \verb+MPIFLAGS+. 
The name of the Fortran 90 compiler (usually gfortran or ifort) should be 
given by the variable \verb+F90+. Compiler flags and further libraries such as Lapack
are contained in the variables \verb+F90FLAGS+.
When the MPI library is not available, a non-parallel version of the Fortran front end
of \pyOM can be build by \verb+make target=without_mpi <model>+.
The netcdf library is, however, mandatory at the moment.
Currently, the following files for the corresponding systems are provided:

\begin{tabular}{l|l|l}
 file name &  \verb+HOSTTYPE+ & system \\\hline
\verb+site_specific.mk_i686-linux+ & \verb+i686-linux+ & generic 32 bit Linux (Ubuntu, etc) \\
\verb+site_specific.mk_x86_64-linux+ & \verb+x86_64-linux+ & generic 64 bit Linux  \\
\verb+site_specific.mk_intel-mac+ & \verb+intel_mac+ & Mac OSX\\
\verb+site_specific.mk_thunder+ & \verb+x86_64-linux+ & a specific 64 bit Linux server \\
\verb+site_specific.mk_mistral+ & \verb+x86_64-linux+ & another specific platform \\
\verb+site_specific.mk_rs6000+ & \verb+rs6000+ & a specific AIX power pc
\end{tabular}



\subsection{Python front end}


The following steps are needed to use the Python front end of \pyOM
\begin{itemize}
\item Determine which site-specific Makefile options will be read by the compiler. Type

echo \verb+site_specific.mk_${HOSTTYPE}+ 

to see the file name that will be read and which needs to be provided. For details see description
of Fortran front end installation.
\item  Change directory to \verb+dir/py_src+ and type \verb+make+.
\item Run one of the example Python scripts in  \verb+dir/py_config+.
\end{itemize}
To compile the extension module for Python from the Fortran subroutines and modules
 a number of Python modules are needed.
The numerical module \verb+numpy+ is mandatory, the modules \verb+mpi4py+,
\verb+scipy+, \verb+Tkinter+, \verb+matplotlib+ and \verb+netcdf4+ or \verb+Scientific.IO.netcdf+
are optional.
Two extension modules will be build automatically, one with and one without
MPI support, named 
\verb+dir/pyOM_code_MPI.so+ and/or \verb+dir/pyOM_code.so+, respectively.
%
 For the former, it is necessary to provide the path to the MPI library and include header files
in the configuration file \verb+dir/site_specific.mk_${HOSTTYPE}+ in the variables \verb+F2PY_MPIFLAGS+.
Further compiler flags and libraries that are needed are specified in  \verb+F2PY_FLAGS+.
The other variables in  \verb+dir/site_specific.mk_${HOSTTYPE}+ are not used.

When the extension modules \verb+dir/pyOM_code.so+ and/or \verb+dir/pyOM_code_MPI.so+ are build, the 
Python front end can be used by executing \verb+python <model>.py+ in the
directory \verb+dir/py_config+, where \verb+<model>+ denotes one of the example
configurations in the directory \verb+dir/py_config+.
The extension module \verb+dir/pyOM_code_MPI.so+ contains MPI support
and is loaded automatically when available, otherwise   \verb+dir/pyOM_code.so+ is loaded.
The examples in  \verb+dir/py_config+ are based on different classes, which differ
by using additional Python modules. The basic class is contained in the Python module
\verb+pyOM.py+ and should work as long as one of the extension modules have been
built. Extensions of this basic class are given by 

\begin{itemize}
\item \verb+pyOM_cdf.py+ which adds
basic netcdf-based IO to \verb+pyOM.py+ using the Python modules \verb+netcdf4+ or \verb+Scientific.IO.netcdf+.
\item \verb+pyOM_ave.py+ which adds time averages to \verb+pyOM_cdf.py+
\item \verb+pyOM_gui.py+ which adds a graphical user interface to \verb+pyOM_ave.py+ 
using \verb+Tkinter.py+ and plotting during model execution using \verb+matplotlib+.
\end{itemize}
The classes are imported by each of the examples in \verb+dir/py_config+.


\section{Directory structure and model configuration}

\subsection{Directory structure}

The numerical code is distributed over several directories. Here is a list
of these directories and a short characterisation of its content.
All references to files or directories are relative to the directory in which \pyOM is located.
\begin{itemize}
\item \verb+./for_src+: Fortran subroutines used by both Fortran and Python front end
\begin{itemize}
\item \verb+./for_src/main+: Main module and subroutines
\item \verb+./for_src/external+: Solver for surface pressure or streamfunction
\item \verb+./for_src/non_hydrostatic:+ Routines for non-hydrostatic terms
\item \verb+./for_src/parallel+:  Routines for communication between processors
\item \verb+./for_src/density+: Routines for equation of state of sea water
\item \verb+./for_src/isoneutral+: Routines for mixing along neutral surfaces
\item \verb+./for_src/tke+: Small-scale mixing closure by \cite{Gaspar:90}
\item \verb+./for_src/eke+: Meso-scale eddy mixing closure by \cite{Eden:06c}
\item \verb+./for_src/idemix+: Internal wave mixing closure by \cite{Olbers:13}
\item \verb+./for_src/obc+: Open boundary formulation
\item \verb+./for_src/advection+: Routines for passive and active tracer advection
\item \verb+./for_src/tracer+: Routines for optional passive tracer
\item \verb+./for_src/diagnostics+: Routines for diagnostics (used by Fortran only)
\item \verb+./for_src/etc+: Miscellaneous routines
\end{itemize}
\item \verb+./py_src+: Python modules and extension modules
\item \verb+./py_config+:  configuration examples of Python front end
\item \verb+./for_config+: configuration examples for Fortran front end
\item \verb+./doc+: contains this documentation
\item \verb+./bin+: contains executable of Fortran front end after successful compilation
\item \verb+./setups+: contains a few specific realistic setups in subdirectories
\end{itemize}
The directory  \verb+./for_src+ is again subdivided into several subdirectories containing
certain aspects of the code. The main code is located in  \verb+./for_src/main+. 
The top-level program of the Fortran front end is  \verb+./for_src/main/main.f90+. 
Here, the work flow of the main routines can be seen.
The basic class for the Python front end is in \verb+./py_src/pyOM.py+, which does
essentially the same as  \verb+./for_src/main/main.f90+.
The main module is located in \verb+./for_src/main/main_module.f90+, is available to both front ends
and contains all important
parameters and model variables. A short description of the most important model variables
can be found in  \verb+main_module.f90+. Other modules containing documentation
are \verb+./for_src/tke/tke_module+ containing everything concerning the small-scale mixing closure,
 \verb+./for_src/tke/eke_module+, containing prognostic meso-scale mixing closures, 
\verb+./for_src/tke/idemix_module+, containing the IDEMIX closure for internal gravity waves,  
 \verb+./for_src/tke/isoneutral_module+, containing the along-isopycnal mixing package, 
  \verb+./for_src/tke/diagnostic_module+, containing everything related to diagnostics.
  Several other modules will also be build. 


\subsection{Model configuration}

The model configuration is realized by template subroutines (Fortran front end)
or template methods (Python front end) for which
specific realizations are supplied for each specific experiment. The idea is
to keep the whole model configuration in a single source code file containing 
all relevant routines. Specific examples can be found in the directory \verb+./py_config+
and \verb+./for_config+. Template Fortran routines and  Python methods  are named identical. 
 A complete list of them is given here. 
\begin{itemize}
\item \verb+set_parameter+:

sets all important fixed model parameters, like domain size, etc.
The configuration is specified mainly by logical switches, implementing 
mixing parameterizations, hydrostatic approximation, etc. which is explained in detail below.
This routine/method is called only once before allocating the model variables.

\item \verb+set_grid+:

sets the (vertical and horizontal) resolution by specifying the variables
\verb+dxt+, \verb+dyt+, and \verb+dzt+. Units are $m$ for the latter
and either also  $m$ or degree longitude or latitude for  \verb+dxt+, \verb+dyt+, respectively, 
if the logical switch \verb+coord_degree+ is true.  The origin of the grid in $x$ and $y$
can be set by \verb+x_origin+ and \verb+y_origin+ with corresponding units.
Based in this input, the u-centered grid as detailed below is set up.
This routine/method is only called once during the model setup after allocating the model variables.

\item \verb+set_coriolis+:

sets the Coriolis parameter in the  double precision fields \verb+coriolis_t+ and
\verb+coriolis_h+. Both are two-dimensional (physical dimensions $x$ and $y$) to allow
for rotated grids.
This routine/method is only called once
during the model setup after \verb+set_grid+.

\item \verb+set_topography+

sets the topography which is given by the two-dimensional (physical dimensions $x$ and $y$) 
integer field \verb+kbot+. A value of zero
denotes land,  $1 \leq$ \verb+kbot+ $ \leq$ \verb+nz+ denotes the vertical index of the
deepest wet grid point. This routine/method is only called once
during the model setup after \verb+set_coriolis+.

\item \verb+set_initial_conditions+

sets the initial conditions for all model variables.
This routine/method is only called once during the model setup after \verb+set_topography+.



\item \verb+set_forcing+

can be used to set time dependent surface boundary conditions
or restoring zones. This routine/method is called at the beginning of each time step.

\item \verb+set_diagnostics+

can be used to register variables to be averaged. In Python front-end only available
in class \verb+pyOM_ave+. This routine/method is only called once during the model setup after
all configuration is done.

\item \verb+set_particles+

can be used to initialize the position of particles integrated simultaneously. 
This routine/method is only called once during the model setup after all configuration is done.

 \end{itemize}
The Fortran template routines have to be present in any case, even when they are empty.
For the Python front end, only the methods which are actually changed are necessary.
The following  methods are available for the Python front end only
\begin{itemize}
\item \verb+user_defined_signal+

is a method which is called by all processors when the leading processor 
has signaled so. Can be used to exchange data for plotting with the GUI versions
in parallel execution.

\item \verb+make_plot+

makes a plot for the GUI version.
\end{itemize}

\subsection{Running and restarting the model}

After successful compilation of the Fortran front end, the executable  can be found in the directory
\verb+./bin+. The executable can be run directly in \verb+./bin+ or in any other directory.
No further files are needed for a model integration, except for configurations which read data 
from specific (binary or netcdf) forcing files.
For the Python front end, the location of the module files have to be specified.
This is done in the first line of each example in \verb+./py_config+. %The model is started with the method \verb+run+. 

\subsubsection{Running and restarting the Fortran front end}

The model integration will start from the initial conditions as specified in the
 configuration templates (if no restart files are present, see below)
 and will integrate over a time period specified by the variable
 \verb+runlen+  which can be found in \verb+main_module+.
 After that period the integration stops and a (or several) restart file(s)
will automatically be written by the Fortran front end,
containing the last two time steps of each model variable. 
The files are named \verb+restart_PE_'my_pe'.dta+ where the variable \verb+my_pe+ is
identical to the one in \verb+main_modules+  and denotes the ordinal number of the respective processor.

The restart files
will be read automatically when the model is restarted. 
Note that the Fortran front end will always try to read a restart file, which then overides
the initial conditions specified in the template configuration routines.
If there is no restart file present, the Fortran front end will use the initial conditions.
Note also that at the end of each integration, any existing restart file will be overwritten.

\subsubsection{Running and restarting the Python front end}

After initializing the instance of the class \verb+pyOM+ (or derivatives of it)
the model is started by the method \verb+run+. The length of the run
is specified by the parameter \verb+runlen+ for the method \verb+run+,
the snapshot intervall by the parameter \verb+snapint+, both in seconds.
The methods \verb+read_restart+ and \verb+write_restart+ are implemented for the Python front end for
reading and writing the restarts in the same format as the Fortran front end.
In the GUI-version \verb+pyOM_gui.py+, the snapshots and 
restarts can be written at any time using the corresponding buttons.

\subsection{Sample configurations}

This is an incomplete list of sample configurations which can be found
either in the directory \verb+./for_config+ or  in  \verb+./py_config+, or in both.

\begin{itemize}
\item \verb+kelv_helm1.py/f90+

A  nonhydrostatic configuration of a  two-layer system with a large shear between the layers to demonstrate 
Kelvin-Helmholtz instabilities.
The domain is two-dimensional, i.e. in the $x$-$z$ plane,
periodic in $x$ and $y$,  and there are no surface fluxes
at the top or bottom, but a zone in the westernmost part of the domain, where temperature
and velocity are relaxed towards the initial conditions. 
The initial conditions are two layers of equal thickness
but different buoyancy moving to the east and relative to each other. 
At the layer interface a small disturbance  is introduced
such that in the simulation Kelvin-Helmholtz instability will show up.



\item \verb+holmboe1.py/f90+

Similar to  \verb+kelv_helm1.py/f90+ but without relaxation zone
and different initial condition corresponding to an Holmboe instability.
The initial small disturbance is taken as the fastest growing mode of a
 linear stability analysis of the initial conditions.


\item \verb+internal_wave1.py/f90+

A nonhydrostatic  configuration to demonstrate internal wave beams.
The domain is two-dimensional, i.e. in the $x$-$z$ plane
and in the center a wave maker is placed.
The variable \verb+fac+ can be increased in order to increase
the spatial (and temporal) resolution. 
The temperature variable of the model is in this case a temperature
perturbation, 
the effect of the background stratification on the perturbation temperature
is implemented in the configuration routine \verb+set_forcing+. 

\item \verb+rayleigh1.py/f90+


A nonhydrostatic  configuration to demonstrate Rayleigh-Bernard convection.
The domain is two-dimensional, i.e. in the $x$-$z$ plane, and
the are top and bottom heat fluxes.
The variable \verb+fac+ can be increased in order to increase
the spatial (and temporal) resolution. 


\item \verb+jets1.py/f90+

A hydrostatic  configuration to demonstrate eddy-driven zonal jets.
A wide channel model with relaxation at the side walls and interior
damping as in \cite{Eden:09b}, simulating strong eddy-driven zonal jets. 

\item \verb+eady1.py/f90+

A hydrostatic  configuration to demonstrate
the classical Eady problem \citep{Eady:49}.
A narrow channel on an $f$-plane with prescribed stratification and
vertically sheared background zonal flow.
The temperature variable of the model is in this case a temperature
perturbation, 
the effect of the background stratification on the perturbation temperature
is implemented in the configuration routine \verb+set_forcing+. 

\item \verb+eady2.py/f90+

Similar to \verb+eady1.py/f90+, but the small initial perturbation 
is calculated from the fastest growing mode of a linear stability analysis
of the initial condition.


\item \verb+acc1.py/f90+

A  hydrostatic model with a channel attached to a closed basin, similar
to the Southern and Atlantic Ocean as in \cite{Viebahn:09}. There is wind forcing
over the channel part and temperature relaxation driving
a large-scale meridional overturning circulation.

\item \verb+acc2.py/f90+

A  hydrostatic model using spherical coordinates with a partially closed domain. 
There is wind forcing over the channel part and buoyancy relaxation driving
a large-scale meridional overturning circulation.




\end{itemize}


\subsection{Realistic configurations}

Several realistic model configurations can be found in \verb+./setups+.
Forcing files are provided at \verb+https://wiki.cen.uni-hamburg.de/ifm/TO/pyOM2+.

\begin{itemize}
\item \verb+flame_low/setup1.py/f90+

North Atlantic configuration with horizontal resolution of $4/3^o \times 4/3^o$ and 45 levels.
Based on the FLAME model configuration used in e.g. \cite{Eden:99c}.
\item  \verb+global_4deg_45level/setup1.py/f90+

Quasi-global configuration with $4^o \times 4^o$ and 45 levels.
\item  \verb+global_1deg/setup1.py/f90+

Quasi-global configuration with $1^o \times 1^o$ and 100 levels.
\end{itemize}


\section{Parameterisations and boundary conditions}

In this section, the most important sub-grid-scale parameterizations and
boundary conditions which 
are used in the model and also other important aspect of the numerical
implementation are listed and briefly discussed.
All references to files containing code
are relative to the directory in which \pyOM is located.
All parameters need to be given in SI units.

Parameterizations or boundary conditions are specified by logical variables which are either contained
in the main module \verb+./for_src/main/main_module.f90+ or in the modules of the respective
parameterization. These logical variables are set to a false value by default, except for some
which are noted below. 


\subsection{Streamfunction or surface pressure}

To obtain the pressure in the Boussinesq system of equations 
 it is necessary to solve a diagnostic relation for the pressure. In case of the hydrostatic assumption
 with a rigid lid i.e. $w=0$ at $z=0$, 
this relation simplified to one of the surface pressure only. An alternative formulation involved
a streamfunction  for the depth-averaged flow as detailed below.
Setting the logical switch \verb+enable_streamfunction+  to a true value
enables a streamfunction formalism, otherwise the surface
pressure itself is found.  The former algorithm is more stable, but involved a special
treatment of island integrals as detailed below. In both cases an iterative conjugate gradient method
to solve diagnostic relations is used controlled by the stop criterion \verb+congr_epsilon+ and 
the maximal allowed iterations by \verb+congr_max_iterations+.

It is also possible to relax the rigid-lid assumption and to
use a linearized free surface formulation by the switch \verb+enable_free_surface+,
 but then energy conservation is not given anymore.

\subsection{Lateral and surface boundary conditions}

Lateral boundary conditions are no-flux boundary condition for
tracers and free-slip for momentum
or periodic boundary conditions (or open boundary conditions as detailed below). 
Zonal periodic boundary conditions can be chosen by setting
the logical switch \verb+enable_cyclic_x+ 
to a true value in the configuration subroutine/method \verb+set_parameter+ to 
apply periodic boundary conditions for all variables in zonal  direction.
The logical switch \verb+enable_cyclic_y+  applies periodic boundary conditions in meridional direction.
Surface and eventually bottom fluxes of buoyancy and momentum can be specified
in the configuration subroutine/method  \verb+set_initial_conditions+ and
\verb+set_forcing+.

Open boundary conditions using a radiation condition at the northern, southern, eastern or western wall of the model
domain can be set in the module \verb+dir/for_src/obc/obc_module.f90+.
Additional damping zones can be implemented there as well.

\subsection{Conservation of energy}

Energy is exchanged consistently between the different reservoirs setting the logical
variables \verb+enable_conserve_energy+ to a true value, which is also the default setting.
For energy conservation, the dissipation rates by all frictional and mixing effects need to be calculated
which considerably increases computing time, such that it might become necessary to disable
energy conservation for specific configurations. This should be done in 
the template configuration subroutine/method \verb+set_parameter+ by setting
 \verb+enable_conserve_energy+ to a false value.
 
 There are some choices to be made for energy consistency.
 Setting the logical switch \verb+enable_store_cabbeling_heat+ to a true value, the nonlinear heating 
 rates due to vertical, lateral and isopycnal mixing in the presence of the the non-linear equation of state  
 are transfered to heat (where it can be neglected), otherwise it is transferred to the respective
 sug-grid reservoir (TKE or EKE). Numercal advection of temperature and salinity also needs energy,
 even using the 2.nd order advection scheme. This energy is taken either from the heat reservoir
 or from TKE by setting \verb+enable_take_P_diss_adv_from_tke+ to a true value. 
 Before taking this energy from TKE, the global mean energy need is calculated and subtracted locally
 to guarantee positive TKE values.
 Setting \verb+enable_store_bottom_friction_tke+ to a true value, energy release by bottom friction 
 is transferred to TKE instead of internal wave energy. 


\subsection{Hydrostatic approximation and convective adjustment}

The hydrostatic approximation is enabled by the logical variable \verb+enable_hydrostatic+. 
It is true by default,
for a non-hydrostatic configuration it needs to be set to a false value 
in the configuration subroutine/method \verb+set_parameter+.
Note that when using the hydrostatic approximation the 
three-dimensional Poisson equation for the full pressure does
not have to be solved, such that the model integration can be much faster.

Using the hydrostatic approximation, 
static instabilities are removed by setting the vertical
diffusivity to a large value. This procedure is sometimes called
convective adjustment. Using the TKE parameterization by \cite{Gaspar:90} (see below),
 convective adjustment
is done automatically.


\subsection{Spherical coordinates}

For realistic configurations, the model can use pseudo-spherical coordinates as 
specified below in Section \ref{sec6}. These coordinates are enabled with the logical variable
\verb+coord_degree+, which is set to a false value be default.
For a false value of  \verb+coord_degree+ all metric terms in the momentum equation are set to zero,
and the factor $\cos \phi$ or $1/\cos \phi$ showing up in the differential operators 
is set to one, otherwise the full equations as specified below in Section \ref{sec6} are used.


\subsection{Advection schemes}

Although the choice of the advection scheme is not a sub-grid-scale
parameterisation, it strongly affects the dissipation in the model and is therefore
discussed here as well. 
It is possible to choose between the classical second-order central differences
scheme as the default,  and a second order scheme with superbee flux limiter. The latter
is  implemented 
by setting the logical variable  \verb+enable_superbee_advection+
 to a true value
in the configuration subroutine/method \verb+set_parameter+.
Note that this choice refers to the advection scheme of the tracers but not to the advection of momentum,
which  is always the classical second-order central differences scheme.
Note also that the positive definite superbee scheme introduces a certain amount of numerical diffusion, 
such that sometimes no additional diffusion is needed in the
model simulation.  There also also   \verb+enable_dst3_advection+,
 \verb+enable_upwind3_advection+  which enable 3.rd order direct space time
 and 3.rd order upwind schemes for tracer advection, respectively.

Setting the switch \verb+enable_AB_time_stepping+ to a true value 
enables Adam-Bashforth time stepping for the chosen advection scheme (default), 
otherwise forward time stepping will be used.

\subsection{Constant lateral and vertical friction and mixing}

Lateral harmonic friction acting on the horizontal velocity ($u$, $v$) can be enable by setting
\verb+enable_hor_friction+ to a true value and is controlled by the horizontal viscosity \verb+a_h+.
Lateral harmonic mixing  acting on the salinity and temperature  is enabled by
\verb+enable_hor_diffusion+ and controlled by the horizontal diffusivity \verb+k_h+.

Vertical harmonic friction and mixing is always present any by default treated by an 
fully implicit formulation to allow for large mixing parameter.
An explicit formulation for friction can be enabled by setting 
\verb+enable_explicit_vert_friction+ to a true value.
The vertical viscosity is set by
\verb+kappam_0+,  and the vertical
diffusivity by \verb+kappah_0+. Default values for all mixing parameters are zero. 
Note that all viscosities and diffusivities should be specified 
in the template configuration subroutine/method \verb+set_parameter+.

\subsection{Bottom and interior friction}

Linear bottom friction is enabled by setting the logical variable
\verb+enable_bottom_friction+ to a true value 
in the configuration subroutine/method \verb+set_parameter+.
The inverse time scale for bottom friction is given by 
\verb+r_bot+. Default value is zero. Quadratic bottom friction is enabled
by \verb+enable_quadratic_bottom_friction+ with parameter \verb+r_quad_bot+. 
Adding interior Rayleigh damping is implemented by
the switch \verb+enable_ray_friction+ and the parameter \verb+r_ray+.




\subsection{Small-scale turbulent mixing closure}

A prognostic TKE model for vertical mixing first introduced by \cite{Gaspar:90}
is enabled with the logical variable \verb+enable_tke+ in the configuration subroutine/method \verb+set_parameter+, 
which then calculates the vertical diffusivities and viscosities. The constant variables \verb+kappam_0+
and \verb+kappah_0+ are not used in this case. Several parameter and  additional options can be set, which are documented
in  \verb+./for_src/tke/tke_module.f90+.


\subsection{Internal wave breaking closure}

The internal wave mixing closure IDEMIX \citep{Olbers:13} is enabled
by the switch  \verb+enable_idemix+ in the configuration subroutine/method \verb+set_parameter+.
 Surface and bottom forcing has to be supplied
by the fields \verb+forc_iw_surface+ and \verb+forc_iw_bottom+, respectively, which
may be set in the template subroutine \verb+set_initial_conditions+. See also the example
config files.   Several additional options can be set, which are documented
in  \verb+./for_src/idemix/idemix_module.f90+.
The gravity wave drag formulation is contained in the file \verb+idemix3.f90+.

\subsection{Meso-scale eddy closure}\label{sec_eke_closure}

Meso-scale eddy mixing is implemented  by along-isopycnal mixing
and an additional eddy-driven advection velocity for tracer, which is usually called
the parameterization by \cite{Gent:94}. The corresponding diffusivities are either prescribed as constant
values of calculated using the  prognostic EKE closure by \cite{Eden:06c}.


\subsubsection{Isoneutral mixing}

Lateral mixing of tracers along neutral surfaces following the formulation by \cite{Griffies:98}
is enabled by setting the logical variable 
\verb+enable_neutral_diffusion+ to a true value in the configuration subroutine/method \verb+set_parameter+.
The isoneutral diffusivity which is used is either given by the constant variable 
\verb+K_iso_0+ or by the diffusivity calculated
by the prognostic EKE closure by \cite{Eden:06c} (see below) if it is enabled.

In case of too steep slopes $s$ of the neutral surfaces, the mixing scheme by  \cite{Griffies:98} becomes unstable.
Therefore the isoneutral diffusivity is multiplied by the factor $d_{taper}$ given by
\beq
 d_{taper}= \frac{1}{2} \left( 1+ \tanh \left( (s_c-|s|)/s_d \right)  \right)
\eeq
where the parameter $s_c$ and $s_d$ are set by the 
variables \verb+iso_slopec+ and  \verb+iso_dslope+, respectively.
In regions with too steep slopes, 
the isoneutral mixing is replaced by lateral mixing using the diffusivity given by
\verb+K_iso_steep+, multiplied with a factor $1-d_{taper}$.


\subsubsection{Eddy-driven advection velocity}

The additional eddy-driven advection velocity is either explicitly calculated in form
of an anti-symmetric (skew) component of the isoneutral mixing operator following \cite{Griffies:98},
which is the default, or by the Temporal Residual Mean (TRM) 
form where the velocities from the momentum equations already contain the eddy-driven components. 
The former version is enabled by the logical \verb+enable_skew_diffusion+ in 
the configuration subroutine/method \verb+set_parameter+. This logical is set to false by default, i.e.
the TRM form is the default.
For  the TRM form, an additional vertical friction term is applied
in the momentum equation with viscosity $K_{gm} f^2/N^2$, where $N$ is the local stability
frequency, $f$ the Coriolis parameter. To limit this viscosity in case of vanishing stratification,
a fixed maximal threshold of 0.01 is applied to the factor   $f^2/N^2$.

$K_{gm}$ denotes the skew diffusivity, either used for the antisymmetric components 
of the isoneutral mixing operator or for the TRM form, and 
 is given either by
the constant variable \verb+K_gm_0+ or   by the prognostically diffusivity of
the EKE closure by \cite{Eden:06c} (see below) if it is enabled.


\subsubsection{Prognostic EKE closure}

The eddy mixing closure by \cite{Eden:06c} is enabled
by setting the switch  \verb+enable_eke+ to a true value in the configuration subroutine/method \verb+set_parameter+.
Several parameter for this closure and additional options can be set, which are documented
in  \verb+./for_src/eke/eke_module.f90+.


\section{Diagnostic output}





Simple text based output  is written to standard output  (i.e on the screen). 
More complex diagnostic output 
is written by the Fortran front end in NetCDF format following usual conventions.
The output can be easily visualised by e.g. the free
software \verb+ferret+ available at \verb+http://ferret.wrc.noaa.gov/Ferret+.
For the python frontend, graphical output during the model integration is possible.

\subsection{Time step monitor and snapshots of model variables}

\subsubsection{Fortran frontend}

If the logical variable \verb+enable_diag_ts_monitor+ is set to a true value,
the model time and the number of iterations of the
two- and three-dimensional Poisson solver is written to standard output. 
Also the maximum horizontal and vertical CFL numbers are diagnosed.
The interval of the output is controlled by the variable
\verb+ts_monint+ in seconds. 

If the logical variable \verb+enable_diag_snapshots+ is set to a true value,
snapshots  of the model variables are written by the Fortran front end subsequently to
a NetCDF file \verb+pyOM.cdf+. Any existing file of this
name will be overwritten during model start.
The frequency of the output is controlled by the variable
\verb+snapint+.
The value of \verb+snapint+ gives the number of seconds between subsequent
snapshots written to \verb+pyOM.cdf+.

All diagnostics are inactive by default and need to be enabled by logical variables
in  the configuration subroutine \verb+set_parameter+.
The logical variables can be found in
 \verb+./for_src/diagnostics/diagnostics_module.f90+.


\subsubsection{Python frontend}

Model time and the number of iterations of the
two- and three-dimensional Poisson solver is written by the method \verb+diagnose+ 
to standard output in intervals specified by the parameter \verb+snapint+ given to the method \verb+run+ used
to start the integration.
\verb+pyOM_cdf.py+ extents \verb+diagnose+ by output of model variables
to the NetCDF file \verb+pyOM.cdf+ with the same interval.

Using \verb+pyOM_gui.py+ extents the diagnosis by online plotting
specified in the template method \verb+make_plot+.
Examples are provided in \verb+./py_config+.


\subsection{Time averages}

\subsubsection{Fortran frontend}

Time average diagnostic  can be enabled by the respective switch  \verb+enable_diag_timeave+ in
the Fortran front end.
Output is written to the NetCDF file \verb+averages_'itt'.cdf+ where \verb+itt+ is the time step number,
 with frequency
given by \verb+aveint+ in seconds in the configuration subroutine \verb+set_parameter+.
The variable \verb+avefreq+ gives the frequency of individual averaging operations
and can be larger than the time step. Note that at the beginning of the simulation, one or several files with names
\verb+unfinished_averages_PE_'my_pe'.dta+ will be read
if they exist, which contain unfinished time averages written at the end of a proceeding simulation with
the same configuration. The variable \verb+my_pe+ is the ordinal number of each processor.
At the end of each simulation, the restart files for the time averaging 
will be overwritten.

The variables to be averaged are specified in the template routine \verb+set_diagnostics+.
Examples are provided in \verb+./for_config+.

\subsubsection{Python frontend}

The Python class \verb+pyOM_ave.py+ implements also time averages. The interval is given by 
the parameter \verb+snapint+ of the method \verb+run+.
The variables to be averaged are specified in the template method \verb+set_diagnostics+.
Examples are provided in \verb+./py_config+.

\subsection{Variances}

\subsubsection{Fortran frontend}

Second order quantities eddy kinetic energy and eddy density fluxes are  calculated
 by setting  \verb+enable_diag_variances+  to a true value.
Output is written to the NetCDF file \verb+variances_'itt'.cdf+ where \verb+itt+ is the time step number,
  with frequency
given by \verb+varint+ in seconds in the configuration subroutine \verb+set_parameter+.
The variable \verb+varfreq+ gives the frequency of individual averaging operations
and can be larger than the time step. Note that at the beginning of the simulation, one or several files with names
\verb+unfinished_variances_PE_'my_pe'.dta+ will be read
if they exist, which contain unfinished time averages written at the end of a proceeding simulation with
the same configuration. The variable \verb+my_pe+ is the ordinal number of each processor.
At the end of each simulation, the restart files for the variances
will be overwritten.


 \subsubsection{Python frontend}
 
No such feature implemented.

\subsection{Energy diagnostics}

\subsubsection{Fortran frontend}

Globally averaged energies and transfer terms can be diagnosed by setting the logical variable
\verb+enable_diag_energy+ to a true value.    
Output is written to standard out and in the NetCDF file \verb+energy.cdf+.
The variable \verb+energint+ specified the number of second between subsequent
output. All related variables are averaged   between  subsequent
output intervals. The variable \verb+energfreq+ gives the frequency of individual averaging operations
and can be larger than the time step.

 \subsubsection{Python frontend}

There is no python implementation for this diagnosis 
at the moment.


\subsection{Meridional overturning}

\subsubsection{Fortran frontend}

Zonally integrated transports above different (potential) density classes are written in 
intervals  \verb+overint+ to a file \verb+over.cdf+
if the logical variables \verb+enable_diag_overturning+ is set to a true value.
 Any existing file of this
name will be overwritten during model start.
 The variable \verb+overfreq+ gives the frequency of individual transport calculations
and can be larger than the time step.
The number  of  density levels, reference depth for potential density, and range of density values
are set in the subroutine \verb+init_diag_overturning+ in the file \verb+./for_src/diagnostics/diag_over.f90+
and might need to be adjusted.  Transports interpolated to the modified density 
are also calculated, the results corresponds to the Quasi-Stokes transport streamfunction
by \cite{McDougall:01}.

 \subsubsection{Python frontend}

There is no python implementation for this diagnosis 
at the moment.


\subsection{Particles}

\subsubsection{Fortran frontend}

Particles or floats can be integrated using the switch \verb+enable_diag_particles+ in the Fortran front end.
The initial position of the particles is set in the user defined routine \verb+set_particles+.
Output is written to the NetCDF file \verb+float.cdf+ with frequency \verb+particles_int+. 
Restart are written to and read from \verb+particles_restart.dta+.

 \subsubsection{Python frontend}

There is no python implementation at the moment.



\section{Continuous equations}\label{sec6}

The relevant equations for a fluid in Boussinesq approximation on an rotating pseudo--spherical
coordinate system are given here for reference and can e.g. be found in \cite{Olbers:11}.
For the moment
the hydrostatic and traditional approximation are applied (which will be relaxed below). 
The primitive equations for momentum are
\beq
 \pt{}  u  &=& \delta u - \frac{1}{a \cos \phi } \p_\lambda p_s 
 ~~,~~\delta u = f v   - \frac{1}{a \cos \phi } \p_\lambda p_{hyd}  + \frac{uv}{a} \tan \phi  + \pz{} A_v \pz{}  u -\vn   \cdot  \v u u
 \\
 \pt{} v  &=&  \delta v  - \frac{1}{a } \p_\phi p_s 
 ~~,~~\delta v =   - f u - \frac{1}{a } \p_\phi p_{hyd} - \frac{u^2}{a} \tan \phi + \pz{} A_v \pz{}  v  -\vn   \cdot  \v u  v
 \\ 0 &=& - \pz{} p - g \rho/\rho_0
\eeq
with geographical longitude and latitude $\lambda$ and  $\phi$ and velocity components $u$ and $v$ in
those directions, respectively. Note that
a factor $\rho_0$ is absorbed in the pressure $p=p_s+p_{hyd}$, and that further frictional
terms might be added to the time tendencies $\delta u$ and $\delta v$.
The non-linear advection terms are defined below.
Vertically integrating the vertical momentum equation and using a rigid lid yields
\beq
 \int_z^0 \pz{} p = - \int_z^0 dz g \rho/\rho_0 = p |_0 - p
 ~\to~ p = p_s + p_{hyd} ~,~p_{hyd} =  \int_z^0 dz g \rho/\rho_0 
\eeq
The continuity equation is given by
\beq
\frac{1}{a \cos \phi } \left(   \p_\lambda u + \p_\phi (v \cos \phi ) \right) + \pz{} w = 0
\eeq
which can be integrated to obtain $w$. 
We use a conservation equation for salinity $S$
\beq
%\dt{\rho}=  \pt \rho + \frac{1}{a \cos \phi } u \p_\lambda \rho + \frac{1}{a} v \p_\phi \rho + w \pz{} \rho &=&   \\
  \pt S +  \frac{1}{a \cos \phi }  \left(    \p_\lambda (u S) +  \p_\phi (v  S \cos\phi)  \right)+ \pz{} (w S) &=&  D_S
 \eeq
where the right hand side terms in $D_S$ are specified later. A corresponding equation for
conservative temperature $\theta$ and an equation of state $\rho=\rho(S,\theta,z)$ closes the system.
 
 
\subsection{Surface pressure}
 
The integration constant $p_s$ is only known diagnostically.
Vertically integrating the horizontal momentum equation and taking the divergence
yields a Poisson equation for the surface pressure $p_s$:
\beq
 \frac{1}{a \cos \phi } \left(  \p_\lambda  \frac{1}{a \cos \phi } h \p_\lambda p_s 
    + \p_\phi \cos \phi  \frac{1}{a } h \p_\phi p_s  \right)  &=& \frac{1}{a \cos \phi } \left( \p_\lambda   \int_{-h}^0 dz \delta u 
   + \p_\phi \cos \phi  \int_{-h}^0 dz \delta v   \right)
\eeq
which can be solved at each time step. Alternatively it is possible to derive a corresponding
equation for a streamfunction.
Vertically averaging the horizontal momentum equation and taking the curl yields
\beq
% \pt{} \int_{-h}^0 dz  u   &=&  \int_{-h}^0 dz \delta u  - \frac{1}{a \cos \phi } h \p_\lambda p_s \\
%  \pt{} \int_{-h}^0 dz  v    &=&  \int_{-h}^0 dz \delta v    - \frac{1}{a } h \p_\phi p_s \\ 
   \frac{1}{a \cos \phi } \pt{}  \lk  \p_\lambda \frac{1}{h} \int_{-h}^0 dz  v 
      -   \p_\phi \frac{1}{h}  \int_{-h}^0 dz  u \cos \phi   \rk 
   &=& 
    \frac{1}{a \cos \phi }   \lk  \p_\lambda \frac{1}{h}  \int_{-h}^0 dz \delta v    
    -   \p_\phi \frac{1}{h} \int_{-h}^0 dz \delta u   \cos \phi   \rk 
  \eeq
which is a Poisson equation for the temporal change of the streamfunction of the depth averaged flow.
An alternative surface boundary formulation to the rigid lid is given by the 
implicit free surface.  The  free surface equation is given by 
\beq 
 \pt{} \eta + \nabla_h \cdot \int_{-h}^\eta \v u_h dz 
\approx  
 \pt{} \eta + \nabla_h \cdot \int_{-h}^0 \v u_h dz 
=0
\eeq
where the free surface $\eta$ is related to the surface pressure by $p_s=g\eta$.

\subsection{Pseudo-Cartesian coordinate system}

Pseudo-Cartesian coordinates are now defined as
$x = \lambda/a $ and $y =  \phi/a$.
The relevant equations become
\beq
 \pt{}  u  &=& \delta u - \frac{1}{\cos \phi } \px p_s 
 ~~,~~\delta u = f v   - \frac{1}{ \cos \phi } \px p_{hyd}  + \frac{uv}{a} \tan \phi  - \vn \cdot \v u  u + \pz{} A_v \pz{}  u 
 \\
 \pt{} v  &=&  \delta v  - \py p_s 
 ~~,~~\delta v =   - f u -  \py p_{hyd} - \frac{u^2}{a} \tan \phi   + \pz{} A_v \pz{}  v - \vn \cdot \v u  v
 \\
  \pt S &=& - \vn \cdot \v u  S   + D_S
  ~~,~~ \vn \cdot \v u  S  =  \frac{1}{ \cos \phi }  \left(    \px{} (u S) +  \py{} (v   S \cos\phi)  \right)+ \pz{} (w S) 
 \\0 &=& 
 \frac{1}{ \cos \phi } \left(   \px u + \py{} (v \cos \phi ) \right) + \pz{} w
   \\
  0&=& - \left(  \px {} \frac{1}{ \cos \phi } h \px{} p_s 
    + \py{} h \cos \phi  \py{} p_s  \right)  +\left( \px{}  \int_{-h}^0 dz \delta u 
   + \py{} \cos \phi  \int_{-h}^0 dz \delta v   \right)
\\
  0&=& -   \pt{}  \lk  \p_x \frac{1}{h} \int_{-h}^0 dz  v 
      -   \p_y \frac{1}{h}  \int_{-h}^0 dz  u \cos \phi   \rk 
  +    \p_x \frac{1}{h}  \int_{-h}^0 dz \delta v    
    -   \p_y \frac{1}{h} \int_{-h}^0 dz \delta u   \cos \phi   
%
\\   0&=& p_{hyd} -  \int_z^0 dz g \rho/\rho_0 
\eeq


\subsection{Thermodynamics}

We use either the 48-term TEOS equation of state or 
a model equation of state from Vallis (2006)
\beq
\rho =  p_0/c_{s,0}^2 -  \rho_0 \beta_T (1+ \gamma^\star p_0) (\theta-\theta_0)
 -  \rho_0 \beta_{T}^\star (\theta-\theta_0)^2/2 + \rho_0 \beta_S (S-S_0) 
\eeq
with $p_0 = - g \rho_0 z$, and parameters 
\beq
 \rho_0 = 1024 \, {\rm kg/m^3}~~,~~ \theta_0 = 9.85 \, {\rm {}^o C} ~~,~~ S_0 = 35
  ~~,~~g=9.81 \, {\rm m/s^2 }~~,~~ c_{s,0} = 1490.0 \, {\rm m/s}
  \\  \beta_T = 1.67 \times 10^{-4} \, {\rm K^{-1}}
 ~~,~~  \beta_{T}^\star = 10^{-5} \, {\rm K^{-2}}
 ~~,~~\beta_S = 0.78\times 10^{-3} ~~,~~ \gamma^\star = 1.1 \times 10^{-8} \, {\rm  m s^2/kg }
 \eeq
 or a simple linear equation of state.
The derivatives of density with respect to $\theta$ and $S$ are given by
\beq
\frac{\p \rho}{\p \theta} &=& 
 \rho_0 \lk -  \beta_T     + \beta_T \gamma^\star g \rho_0 z  - \beta_T^\star (\theta-\theta_0) \rk 
\\
 \frac{\p \rho}{\p S} &=&  \rho_0 \beta_S  
\eeq
Dynamic enthalpy is given by
\beq
 H_d(S,\theta,z) &=& - g/\rho_0 \int_z^0 \rho(S,\theta,z') dz'  
 \\ &=& + g   z^2/2 \lk  -  \frac{g  } {c_{s,0}^2} +   \beta_T  g \rho_0 \gamma^\star  (\theta-\theta_0)\rk
 + g z  \lk -   \beta_T  (\theta-\theta_0)
 -   \beta_{T}^\star (\theta-\theta_0)^2/2 +  \beta_S (S-S_0) 
 \rk  
\eeq
with
\beq
\\ \frac{\p H_d}{\p \theta} &=& -\frac{g}{\rho_0}  \int_{z}^0 \frac{\p \rho}{\p \theta} dz' 
=  g z ( - \beta_T - \beta_T^\star (\theta-\theta_0)  
 +  \beta_T \gamma^\star g \rho_0  \frac{z}{2} )
 \\
\frac{\p H_d}{\p \theta} &=& -\frac{g}{\rho_0}  \int_{z}^0 \frac{\p \rho}{\p S} dz' =   g  z \beta_S  
\eeq 


\subsection{Non-hydrostatic terms}

The hydrostatic and traditional approximation was applied above. Without these the
momentum equation becomes
\beq
 \pt{}  u  &=& - \frac{1}{\cos \phi } \px (p_s+ p_{hyd} + p_{res})  + f v  - f_h w  - \v u \cdot \vn u + \frac{uv}{a} \tan \phi   
 - \frac{uw}{a}
 \\
 \pt{} v  &=&    - \py (p_s +p_{hyd} + p_{res} )   - f u  - \v u \cdot \vn v  - \frac{u^2}{a} \tan \phi   - \frac{vw}{a}
 \\
 \pt{} w &=&  - \pz{} p_{res}   + f_h u   - \v u \cdot \vn w + \frac{u^2+v^2}{a} 
 \eeq
plus frictional terms. $f_h = 2 \omega \cos \phi$ relates to the horizontal component of the
Coriolis force. $p_{res}$ is the non-hydrostatic pressure contribution, which is calculated
from the (uncorrected) total divergence of the flow.
Note that the last terms on the right hand side of the lateral momentum equations are
usually neglected in the pseudo-spherical coordinate system. For consistency,
the metric term in the vertical momentum equation should also be neglected.

\section{Discretization}

\subsection{Numerical grids}

\subsubsection{Spatial grid}

\begin{figure}[h]
\centerline{\includegraphics[width=0.5\textwidth]{cgrid}}
\caption{\small  C-grid
}\label{fig1}
\end{figure}
All variables are discretized on an Arakawa C-grid.
Pressure $p$ and density $\rho$ are centered in a tracer box. On the 
eastern, northern and upper sides of these boxes, the zonal, meridional
and vertical velocities are placed. The horizontal 
grid arrangement is shown in \fig{fig1}. Advective fluxes of density
across the eastern cell border, $F^E_{i,j,k}$
and the corresponding fluxes across the meridional and vertical boundary
can be computed as
\beq
  F^E_{i,j,k} &=&  \Delta x \Delta z \, u_{i,j,k} (b_{i,j,k}+b_{i+1,j,k})/2 \\
  F^N_{i,j,k} &=&  \Delta x \Delta z \, v_{i,j,k} (b_{i,j,k}+b_{i,j+1,k})/2 \\
  F^T_{i,j,k} &=&  \Delta x^2  \, w_{i,j,k} (b_{i,j,k}+b_{i,j,k+1})/2 
\eeq
Note that this discretisation represents the standard second order scheme, but that
other higher order discretisation are possible.
It is also obvious that diffusive fluxes can be discretised in a similar way.
In any case, however, 
the convergence of these fluxes leads to a change in density content in the grid cell
\beq
( \Delta x^2 \Delta z) \pt{} b_{i,j,k}=
 (F^E_{i,j,k}-F^E_{i-1,j,k})
+(F^N_{i,j,k}-F^N_{i,j-1,k})
+(F^T_{i,j,k}-F^T_{i,j,k-1})
\eeq
It is clear that fluxes of density across the boundaries must be set to zero.
For momentum, free-slip or no-slip boundary conditions can be used.

\subsubsection{Non-equidistant spatial grid}

\begin{figure}[h]
\centerline{\includegraphics[width=0.4\textwidth]{grid}}
\caption{\small  Non-equidistant spatial grid
}\label{fig2}
\end{figure}
We count all three spatial indices positive in the respective direction. This also holds for the vertical coordinate.
Tracer such as temperature $\theta$ is given at points $zt_k$. Above $zt_k$ ends the grid cell at the level $zw_k$ which
is given by  $zw_k = (zt_{k+1} + zt_k)/2 $.  The grid box size for the tracer is 
 thus $ \Delta zt_k = zw_k - zw_{k-1}$ and we also define
 $ \Delta zw_k = zt_{k+1} - zt_k$. Figure \ref{fig2} shows the configuration on the grid.
 The vertical velocity is defined at $zw_k$ and is thus in the center of its box, while the tracer point
 $zt_k$ is displaced relative to the center of its box for a non equidistant grid.
 This is sometimes called a $u-$ centered grid.
 The grid in $i$/$x$ and $j$/$y$ direction follow equivalent rules.
The grid sizes $\Delta zt_k$, $\Delta xt_i$ and $\Delta yt_j$ are specified for each model configuration,
from which all levels $zt_k$ and $zw_k$ and zonal positions $xt_i$, $xu_i$, etc can be derived. The sea surface is 
at $zw_N=0\, \rm m$,
where $N$ is the number of vertical levels.


\subsubsection{Time stepping}

To integrate $\v u_h$ an Adam-Bashforth scheme is used but Euler forward for the mixing terms.
\beq
 {\v u}{}_h^{n+1} = {\v u}{}_h^{n} + \Delta t \left( \delta {\v u}{}_{mix}^n  
 + A_1\delta {\v u}{}^n - A_2 \delta {\v u}{}^{n-1} 
 -  \vn_h p_s^{n+1}\right)
\eeq
with $A_1=1.5+\epsilon$, $A_2 = 0.5 + \epsilon$ and $\epsilon = 0.1$, and where
\beq
 \delta u^n &=& f v^n    + \frac{u^n v^n}{a} \tan \phi - \v u^n \cdot \vn u^n  - \frac{1}{ \cos \phi } \px{} p_{hyd}^n
 \\
 \delta v^n &=&   - f u^n  - \frac{u^n u^n}{a} \tan \phi  - \v u^n \cdot \vn v^n -  \py{} p_{hyd}^n
 \\ \delta u^n_{mix} &=&  \pz{} A_v \pz{}  u^{n+1} + \vn_h  \cdot A_h \vn_h u^n - r u^n
 \\  \delta v^n_{mix} &=&  \pz{} A_v \pz{}  v^{n+1}+ \vn_h \cdot A_h \vn_h v^n - r v^n
 \eeq
Similar for $T$ and $S$.


\subsubsection{Array dimensions and parallelization}

All physical field quantities are discretized only for the domain of the respective processor,
which leads to full scalability of the code in terms of memory demands.
Array dimensions are of course identical in Fortran and Python front end, but the referencing of the variables
is slightly different.  First, Fortran array dimensions are detailed: In the Fortran frontend,
the total zonal (meridional, vertical) dimension is  from 1 to \verb+nx+ (\verb+ny+, \verb+nz+).
The domain of a processor extends from \verb+is_pe+ to \verb+ie_pe+ in zonal direction
and from  \verb+js_pe+ to \verb+je_pe+ in meridional direction, and over the full depth.
If there is only one processor  $\verb+is_pe+=1$  and $\verb+ie_pe+=\verb+nx+$ and similar
for the meridional coordinate. In any case, the actual dimension of each physical variable
extents from  \verb+is_pe+-\verb+onx+ to  \verb+ie_pe++\verb+onx+, where  \verb+onx+ denotes the number
of overlapping points between domains in zonal direction and is
set currently to 2. The meridional dimension extents from \verb+js_pe+-\verb+onx+ to \verb+je_pe++\verb+onx+,
with identical parameter \verb+onx+ as for the zonal direction.
The overlapping points in each direction are used to store the respective information of the neighboring processors
during memory exchange, which is done at the end of each time step.

The python module numpy does not allow numerical arrays with other start index as zero. Therefore, the index of
a physical dimension needs to be shifted accordingly to access the Fortran arrays in the Python frontend. 
There are many examples how this is done
in the sample configurations.

\subsection{External mode}


\subsubsection{Surface pressure formulation}


To solve for the pressure field for a rigid lid
\beq
   \px {} \frac{1}{ \cos \phi } h \px{} p_s 
    + \py{} h \cos \phi  \py{} p_s    = \px{}  \int_{-h}^0 dz \delta u 
   + \py{} \cos \phi  \int_{-h}^0 dz \delta v  
\eeq
is inverted to yield $p_s$ at each time step. The following algorithm is used
\beq
 {\v u}{}_h^* &=& {\v u}{}_h^{n} + \Delta t \left( \delta {\v u}{}_{mix}^n  
 + A_1\delta {\v u}{}^n - A_2 \delta {\v u}{}^{n-1} \right)
\\
  \vn_h \cdot h \vn_h p_s^{n+1}   &=&  \frac{1}{\Delta t} \vn_h \cdot  \int_{-h}^0 dz \v u^* 
  \\
  {\v u}{}_h^{n+1} &=& {\v u}{}_h^{n} - \Delta t \vn_h p_s^{n+1} 
\eeq
where $\delta \v u_{mix}$ denote velocity changes related to friction which are excluded from the Adam-Bashforth time stepping.
This scheme is identical to MITgcm. 
The Poisson equation is solved with a simple conjugate gradient solver. 
Problematic are eigenvalues near zero of the matrix 
to be inverted in certain configurations, such the solver diverges. This becomes even worse using
a preconditioner.

\subsubsection{Free surface formulation}

To solve for the surface pressure for a free surface
\beq
 \pt{} p_s + g \nabla_h \cdot \int_{-h}^0 \v u_h dz 
=0 ~,~p_s^{n+1} = p_s^n   - g\Delta t \nabla_h \cdot \int_{-h}^0 {\v u}{}_h^{n+1} dz 
\eeq
the following algorithm is used
\beq
{\v u}{}_h^* &=& {\v u}{}_h^{n} + \Delta t \left( \delta {\v u}{}_{mix}^n  
 + A_1\delta {\v u}{}^n - A_2 \delta {\v u}{}^{n-1} \right)
\\
  p_s^* &=&  \epsilon p_s^n   -  g \Delta t \nabla_h \cdot \int_{-h}^0 {\v u}{}_h^* dz 
 \\   \vn_h \cdot h \vn_h p_s^{n+1}   -p_s^{n+1} \frac{\epsilon}{g\Delta t^2}  &=&   - p_s^* \frac{1}{g \Delta t^2} 
 =    \frac{1}{\Delta t} \vn_h \cdot  \int_{-h}^0 dz \v u^* -  p_s^n  \frac{\epsilon}{g \Delta t^2}
\eeq
For $\epsilon=0$ this becomes the rigid lid version. However, $\epsilon=1$ converges often  much faster.
Problematic are the conservation properties in the uppermost grid boxes.

\subsubsection{Streamfunction formulation}

The transport streamfunction $\psi$ is given by 
\beq
   \frac{1}{ \cos \phi } \lk  \p_x \frac{1}{h}  \frac{1}{ \cos \phi }  \px{}  \pt{}   \psi  
      +   \p_y \frac{1}{h} \cos \phi  \py{}\pt{}    \psi    \rk 
   &=& 
    \frac{1}{ \cos \phi }   \lk  \p_x \frac{1}{h}  \int_{-h}^0 dz \delta v    
    -   \p_y \frac{1}{h} \int_{-h}^0 dz \delta u   \cos \phi   \rk 
  \eeq
with
\beq
  \frac{1}{ \cos \phi }  \px{} \psi = \int_{-h}^0 dz  v ~~,~~ - \py{} \psi =   \int_{-h}^0 dz  u
\eeq
The following algorithm is used
\beq
\vn_h \cdot \frac{1}{h} \vn_h \delta \psi^n &=& \rvec{\vn}{}_h \cdot \frac{1}{h}
 \int_{-h}^0 dz \left( \delta {\v u}{}_{mix}^n   + A_1\delta {\v u}{}^n - A_2 \delta {\v u}{}^{n-1} \right)
 \\ 
  \psi^{n+1} &=& \psi^n + \Delta t \delta \psi^n
\eeq
or with AB. $\psi$ is defined on the vorticity grid with
\beq
  \frac{ (\psi_{i,j} - \psi_{i-1,j})}{\cos \phi u_j  \Delta xt_i} = \int_{-h}^0 dz  v_{ij}
  ~~,~~ - \frac{ (\psi_{i,j} - \psi_{i,j-1})}{ \Delta yt_j}   =   \int_{-h}^0 dz  u_{ij}
\eeq
and
\beq
\rvec{\vn}{}_h \cdot \frac{1}{h} \int_{-h}^0 dz  \delta \v u  &=& 
\frac{ 1/h^v_{i+1,j} \int dz \delta v_{i+1,j} -  1/h^v_{ij} \int dz \delta v_{i,j} }
{\cos \phi u_j \Delta xu_i}
\\ &&
 - \frac{ \cos \phi t_{j+1} /h^u_{i,j+1} \int dz \delta u_{i,j+1} -  \cos \phi t_j 1/h^u_{ij} \int dz \delta u_{i,j} }
{\cos \phi u_j \Delta yu_j}
\\
\vn_h \cdot \frac{1}{h} \vn_h \delta \psi^n &=&
\frac{ \frac{ (\psi_{i+1,j} - \psi_{i,j})}{h^v_{i+1,j} \cos \phi u_j  \Delta xt_{i+1}} 
 -  \frac{ (\psi_{i,j} - \psi_{i-1,j})}{h^v_{ij}  \cos \phi u_j  \Delta xt_i}  }
{\cos \phi u_j \Delta xu_i}
\\ &&
 + \frac{ 
 \cos \phi t_{j+1}  \frac{ (\psi_{i,j+1} - \psi_{i,j})}{ h^u_{i,j+1}  \Delta yt_{j+1}} 
 -  \cos \phi t_j   \frac{ (\psi_{i,j} - \psi_{i,j-1})}{ h^u_{ij} \Delta yt_j}  
 }
{\cos \phi u_j \Delta yu_j}
\\ 
&=& 
\frac{ (\psi_{i+1,j} - \psi_{i,j})}{h^v_{i+1,j} (\cos \phi u_j)^2  \Delta xt_{i+1} \Delta xu_i } 
 -  \frac{ (\psi_{i,j} - \psi_{i-1,j})}{h^v_{ij}  (\cos \phi u_j)^2  \Delta xt_i  \Delta xu_i } 
\\ && +
 \frac{ \cos \phi t_{j+1} }{\cos \phi u_j} \frac{ (\psi_{i,j+1} - \psi_{i,j})}{ h^u_{i,j+1}  \Delta yt_{j+1}  \Delta yu_j } 
 -  \frac{ \cos \phi t_j }{\cos \phi u_j}   \frac{ (\psi_{i,j} - \psi_{i,j-1})}{ h^u_{ij} \Delta yt_j  \Delta yu_j }  
\eeq
The surface pressure contribution to the forcing is
\beq
\rvec{\vn}{}_h \cdot  \vn_h p_s
&=& 
\frac{( p_{i+1,j+1}-p_{i+1,j} )/ \Delta yu_j  -  ( p_{i,j+1}-p_{ij} )/ \Delta yu_j  }
{\cos \phi u_j \Delta xu_i}
\\ &&
 - \frac{    (p_{i+1,j+1}-p_{i,j+1})/ (\Delta xu_i )   -   (p_{i+1,j}-p_{i,j})/ (\Delta xu_i ) }
{\cos \phi u_j \Delta yu_j} = 0
\eeq
The Poisson equation is solved using a conjugate gradient solver with simple 
preconditioner taken from MOM.


\subsubsection{Island integrals for streamfunction}

Island integrals can be treated as follows: Consider the vertically integrated momentum equation
\beq
1/h \pt{} \int_{-h}^0 \v u_h dz &=&  1/h \int_{-h}^0 dz \delta \v u -  \vn_h p_s = 1/h \pt{} \rvec{\vn} \psi 
\eeq
For a closed line integral e.g. around an island, the surface pressure contribution drops 
\beq
\int_C  1/h \, d \v \ell \cdot    \rvec{\vn} \pt \psi   &=& \int_C  1/h \, d\v \ell \cdot   \int_{-h}^0 dz \delta \v u 
\eeq
This relation holds for each island with number $n$ and perimeter $C_n$.
Now we consider the superposition
\beq
 \psi = \psi_0(t,\v x_h) + \sum_n \mu_n(t) \psi_n(\v x_h) 
\eeq
with $\psi_0=0$ along all boundaries, and $\psi_n=const$ along $C_n$ but $\psi_n=0$ along $C_{m\neq n}$ and with
\beq
\vn_h \cdot \frac{1}{h} \vn_h   \psi_n = 0 ~~,~~\vn_h \cdot \frac{1}{h} \vn_h  \pt \psi_0 = 
\rvec{\vn}{}_h \cdot \frac{1}{h} \int_{-h}^0 dz  \delta \v u
\eeq
The first relation is time independent and is solved only once, the second is easily solved with 
simple Dirichlet boundary conditions.
Using the superposition for $\psi$ in the island integrals yields
\beq
\sum_i (\pt \mu_i )\int_{C_n}  1/h \, d \v \ell \cdot  \rvec{\vn}  \psi_i  
 &=& \int_{C_n}  1/h \, d\v \ell \cdot   \int_{-h}^0 dz \delta \v u 
-\int_{C_n}  1/hd \v \ell \cdot   \pt{} \rvec{\vn} \psi_0  
\eeq
This can be solved for each island integral along $C_n$ and yields an algebraic
system for all $\p_t \mu_i$.

\subsection{Discrete kinetic energy}

\subsubsection{Coriolis term}

 A  way to obtain consistent Coriolis terms is the following from MITgcm.
 \beq
  \pt{} u_{ij} + ... &=& 
    0.25   ( f_{ij}  \frac{ \Delta xt_i }{ \Delta xu_i} (v_{i,j} + v_{i,j-1})
             + f_{i+1,j} \frac{  \Delta xt_{i+1}}{\Delta xu_i}   (v_{i+1,j} + v_{i+1,j-1}) )
   \\   \pt{} v_{ij} + ... &=&  - 0.25 (f_{ij}  \frac{\Delta yt_j   \cos \phi t_j }{ \cos \phi u_j \Delta yu_j}  (u_{i,j} + u_{i-1,j}) 
    + f_{i,j+1} \frac{ \Delta yt_{j+1}  \cos \phi t_{j+1}}{ \cos \phi u_j \Delta yu_j}  (u_{i,j+1} + u_{i-1,j+1}) ) 
    \eeq
or
 \beq
  \pt{} u_{ij} +... &=& 0.25 ( f_{ij}  A^t_{ij}  (v_{ij} + v_{i,j-1} )+f_{i+1,j}  A^t_{i+1,j}  (v_{i+1,j} + v_{i+1,j-1} ) ) /A^u_{ij}
\\  \pt{} v_{ij} +... &=& - 0.25 ( f_{ij} A^t_{ij}  (u_{ij} + u_{i-1,j}) +f_{i,j+1} A^t_{i,j+1}  (u_{i,j+1} + u_{i-1,j+1})  ) /A^v_{ij}
 \eeq
 with
 \beq
  A^t_{ij} = \Delta yt_j \Delta xt_i \cos \phi t_j~,~ A^u_{ij} = \Delta yt_j \Delta xu_i \cos \phi t_j
  ~,~A^v_{ij} = \Delta yu_j \Delta xt_i \cos \phi u_j
 \eeq
 Integrating $u^2$ horizontally on the U grid and $v^2$ on the V grid we obtain
\beq
 \sum_{ij} u_{ij} ( f_{ij}  A^t_{ij}  (v_{ij} + v_{i,j-1} )+f_{i+1,j}  A^t_{i+1,j}  (v_{i+1,j} + v_{i+1,j-1} ) ) && 
 \\  - \sum_{ij} v_{ij} ( f_{ij} A^t_{ij}  (u_{ij} + u_{i-1,j}) +f_{i,j+1} A^t_{i,j+1}  (u_{i,j+1} + u_{i-1,j+1})  ) &=& 0
\eeq 
 by shifting the sums. Thus, the Coriolis term discretized in this way does no work.
 
The non-hydrostatic additional terms are
\beq
 \pt{} u_{ijk} + ... &=& ... - 0.25 (  f^h_{ij} A^t_{ij}  (w_{ijk} + w_{ij,k-1})  
     +  f^h_{i+1,j} A^t_{i+1,j}  (w_{i+1,jk} + w_{i+1,j,k-1}) )/A^u_{ij}
  \\  \pt{} w_{ijk}  +...    &=&  ...+       0.25  ( f^h_{ij} \Delta zt_k (u_{i,j,k} + u_{i-1,j,k} ) 
  + f^h_{ij} \Delta zt_{k+1} (u_{i,j,k+1} + u_{i-1,j,k+1} ) )
  /\Delta zw_k
\eeq 
 with the horizontal Coriolis parameter $f_h$. Integrating $u^2$ globally on the u grid and $w^2$ on the w grid
 we obtain 
 \beq
  - \sum_{ijk} (  f^h_{ij} A^t_{ij}  \Delta zt_k   u_{ijk}  (w_{ijk} + w_{ij,k-1})  
     +  f^h_{i+1,j} A^t_{i+1,j}    \Delta zt_k    u_{ijk}  (w_{i+1,jk} + w_{i+1,j,k-1}) ) 
   \\  + \sum_{ijk} (  f^h_{ij}  A^t_{ij}  \Delta zt_k   w_{ijk}   (u_{i,j,k} + u_{i-1,j,k} ) 
                           + f^h_{ij}  A^t_{ij}   \Delta zt_{k+1}  w_{ijk}   (u_{i,j,k+1} + u_{i-1,j,k+1} ) )  = 0
 \eeq
 by shifting the sums.
 
 \subsubsection{Metric terms}
 
 The metric terms $uv a^{-1} \tan \phi $ and $-u^2 a^{-1} \tan \phi$ are discretized like
in the MITgcm as
   \beq
    \pt{} u_{ij} + ... &=&  0.125  a^{-1} \tan \phi t_j (  ( u_{ij}+u_{i-1,j})A^t_{ij}  (v_{ij}+v_{i,j-1})  
    + ( u_{i+1,j}+u_{i,j})A^t_{i+1,j}  (v_{i+1,j}+v_{i+1,j-1})    )/A^u_{ij} 
    \\ &=& 0.125  a^{-1} \tan \phi t_j (   \frac{\Delta xt_i}{\Delta xu_i } ( u_{ij}+u_{i-1,j}) (v_{ij}+v_{i,j-1})  
    + \frac{\Delta xt_{i+1}}{\Delta xu_i} ( u_{i+1,j}+u_{i,j})  (v_{i+1,j}+v_{i+1,j-1})    )
   \eeq
  \beq
   \pt{} v_{ij} + ... &=& - 0.125 a^{-1}  ( A^t_{ij} \tan \phi t_j (u_{ij} + u_{i-1,j} )^2  + 
   A^t_{i,j+1} \tan \phi t_{j+1} (u_{i,j+1} + u_{i-1,j+1} )^2 ) /A^v_{ij}
   \\ &=& 
    - 0.125 a^{-1}  ( \frac{\Delta yt_j   \cos \phi t_j }{ \cos \phi u_j \Delta yu_j}  \tan \phi t_j (u_{ij} + u_{i-1,j} )^2  \\ && + 
  \frac{\Delta yt_{j+1}   \cos \phi t_{j+1} }{ \cos \phi u_j \Delta yu_j}  \tan \phi t_{j+1} (u_{i,j+1} + u_{i-1,j+1} )^2 )
  \eeq 
  The non-hydrostatic metric terms in the vertical momentum equation are
 \beq
  \pt{} w_{ijk} + ... &=&  0.125 a^{-1} \lk    \Delta zt_k \lk u_{i,j,k} + u_{i-1,j,k} \rk^2
   +   \Delta zt_{k+1} \lk u_{i,j,k+1} + u_{i-1,j,k+1}  \rk^2  \rk /\Delta zw_k
   \\ && + 0.125 a^{-1} \lk    \Delta zt_k \lk v_{i,j,k} + v_{i,j-1,k} \rk^2
   +   \Delta zt_{k+1} \lk v_{i,j,k+1} + v_{i,j-1,k+1}  \rk^2  \rk /\Delta zw_k
 \eeq 
  They should be  balanced  by corresponding terms in the lateral momentum equations, which
  are, however, usually neglected in the pseudo-spherical approximation. Thus, we also neglect
  all metric terms in the vertical momentum quation.
  
\subsubsection{Momentum advection}

A kinetic energy conserving momentum advection scheme is given by
\beq
\v u \cdot \vn u &=& (\delta_i  \Bar{U}^i  \Bar{u}^i+\delta_j \Bar{V}^i \Bar{u}^j) / A^u_{ij} 
  +\delta_k \Bar{W}^i \Bar{u}^k  / (\Delta zt_k A^u_{ij})
\\
\v u \cdot \vn v &=& (\delta_i  \Bar{U}^j  \Bar{v}^i+\delta_j \Bar{V}^j \Bar{v}^j ) / A^v_{ij} 
 +\delta_k \Bar{W}^j \Bar{v}^k  / (\Delta zt_k A^v_{ij})
\eeq  
  with $U_{ijk}=\Delta yt_j u_{ijk}$ and $V_{ijk}=\Delta x t_i \cos \phi t_j  v_{ijk}$ and $W = w A^t_{ij}$.
  Or write as
  \beq
\v u \cdot \vn u &=& (F^u_{ij}- F^u_{i-1,j}) / A^u_{ij}  + (F^v_{ij}- F^v_{i,j-1}) / A^u_{ij} + \delta_k \Bar{W}^i \Bar{u}^k  / (\Delta zt_k A^u_{ij})
\\ F^u_{ij} &=&  0.25  (\Delta yt_j  u_{i+1,j}+\Delta yt_j  u_{i,j})(u_{i+1,j}+u_{ij})
\\ F^v_{ij} &=&  0.25 x (\Delta xt_i \cos \phi t_j  v_{i+1,j}+\Delta xt_i  \cos \phi t_j   v_{i,j})(u_{i,j+1}+u_{ij})
 \eeq  
  
\subsubsection{Vertical dissipation} 
   
   For the dissipation due to implicit vertical friction
    $u  \pz{} A_v \pz{} u = \pz{} A_v \pz{} u^2/2 - A_v (\pz{} u)^2$ 
   we obtain
   \beq
  u_{k}^n  (A_{k} (u_{k+1}^{n+1}- u_{k}^{n+1})/\Delta zw_k  
  - A_{k-1} (u_{k}^{n+1}- u_{k-1}^{n+1})/\Delta zw_{k-1} ) /\Delta zt_k=
  \\
   0.5 (A_{k} (u_{k+1}^{n+1} u_{k+1}^n- u_k^{n+1} u_{k}^n)/\Delta zw_k  
    - A_{k-1} (u_k^{n+1} u_{k}^n- u_{k-1}^{n+1} u_{k-1}^n)/\Delta zw_{k-1} ) /\Delta zt_k
   \\  -  0.5 (A_{k} u_k^{n+1} u_{k}^n /\Delta zw_k  + A_{k-1}  u_k^{n+1} u_{k}^n/\Delta zw_{k-1} ) /\Delta zt_k
\\  +   (A_{k} u_{k}^n  u_{k+1}^{n+1} /\Delta zw_k  + A_{k-1}  u_{k}^n u_{k-1}^{n+1} /\Delta zw_{k-1} ) /\Delta zt_k
\\  -  0.5 (A_{k} u_{k+1}^{n+1} u_{k+1}^n/\Delta zw_k  + A_{k-1} u_{k-1}^{n+1} u_{k-1}^n /\Delta zw_{k-1} ) /\Delta zt_k
   \eeq
   so a flux of KE
   \beq
   \pz{} A \pz{} u^2/2 =  
  0.5 \Bar{(A_{k} (u_{k+1}^2- u_{k}^2)/\Delta zw_k  - A_{k-1} (u_{k}^2- u_{k-1}^2)/\Delta zw_{k-1} ) /\Delta zt_k}^i
   \eeq
   and a dissipation term
   \beq 
   -  (A_{k} u_k^{n+1} u_{k}^n /\Delta zw_k  + A_{k-1} u_k^{n+1} u_{k}^n/\Delta zw_{k-1} ) 
  +   (A_{k} u_{k}^n  u_{k+1}^{n+1}/\Delta zw_k  + A_{k-1}  u_{k}^n u_{k-1}^{n+1}/\Delta zw_{k-1} ) 
\\ =    A_{k} u_{k}^n  (u_{k+1}^{n+1} -  u_{k}^{n+1}) /\Delta zw_k  
-  u_k^n A_{k-1}  (u_{k}^{n+1} - u_{k-1}^{n+1}) /\Delta zw_{k-1} = u_k^n (F_k - F_{k-1}) 
    \eeq
    plus 
    \beq
    +   (A_{k} u_{k}  u_{k+1}/\Delta zw_k  + A_{k-1}  u_{k} u_{k-1}/\Delta zw_{k-1} ) 
 -   (A_{k} u_{k+1}^2/\Delta zw_k  + A_{k-1} u_{k-1}^2 /\Delta zw_{k-1} ) 
 \\ = - u_{k+1}  A_{k} (  u_{k+1}- u_{k}  )/\Delta zw_k 
  +  u_{k-1} A_{k-1}  (u_{k}   -  u_{k-1}) /\Delta zw_{k-1} = - u_{k+1} F_k + u_{k-1} F_{k-1} 
    \eeq
  such that
  \beq
   - A (\pz{}  u)^2 =-0.5  \Bar{ ( (u_{k+1} - u_k )  F_k   + (u_k - u_{k-1} ) F_{k-1} )  }^i /\Delta zt_k <0
  \eeq  
  and similar for $v$.
   At the surface and the bottom the fluxes out/in the domain should be taken out of the dissipation.
   At $k=1$
    \beq
      u_{k}  (A_{k} (u_{k+1}- u_{k})/\Delta zw_k  -  F_b ) /\Delta zt_k=
  \\
   0.5 (A_{k} (u_{k+1}^2- u_{k}^2)/\Delta zw_k   ) /\Delta zt_k - u_k F_b/\Delta zt_k
     -  0.5  ( u_{k+1} -  u_{k}) F_k   /\Delta zt_k
     \eeq  
  and at $k=N$
    \beq
  u_{k}  (F_t  - A_{k-1} (u_{k}- u_{k-1})/\Delta zw_{k-1} ) /\Delta zt_k=
  \\
  u_k F_t/\Delta zt_k -  0.5  A_{k-1} (u_{k}^2- u_{k-1}^2)/\Delta zw_{k-1}  /\Delta zt_k 
   -   0.5  ( u_{k} - u_{k-1} ) F_{k-1}  /\Delta zt_k  
   \eeq
Integrate over $z$
\beq
0.5  ( u_{2} -  u_{1}) F_1  +
  \sum_{k=2}^{N-1} 0.5 ( (u_{k+1} - u_k )  F_k   + (u_k - u_{k-1} ) F_{k-1} )   
  +0.5  ( u_{N} - u_{N-1} ) F_{N-1}    
  =
  \\
    \sum_{k=1}^{N-1} 0.5  F_k u_{k+1} -  \sum_{k=1}^{N-1} 0.5  u_k   F_k  
  + \sum_{k=2}^{N} 0.5  F_{k-1} u_k - \sum_{k=2}^{N} 0.5 u_{k-1}  F_{k-1}    =
    \sum_{k=2}^{N}   F_{k-1} (u_{k} -   u_{k-1})  
   \\ = \sum_{k=1}^{N-1}   F_{k} (u_{k+1} -   u_{k}) 
  %
   \eeq  
with $F_0=F_N=0$. In the TKE equation on the $W$ grid it is thus adequate to add
\beq
\Bar{ F_k (u_{k+1}^n -   u_{k}^n)/\Delta zw_k}^i 
\eeq
as forcing by vertical dissipation.





\subsubsection{Dissipation by Rayleigh friction}

Rayleigh friction $-r \v u$ in the momentum equation yields $-r u^2 - r v^2$ as energy sink.
The discrete form interpolated horizontally on $T$ grid  is
\beq
S_{ijk}= - r 0.5 (u_{i,j,k}^2 + u_{i-1,j,k}^2) - r 0.5( v_{i,j,k}^2 + v_{i,j-1,k}^2)  
 \eeq
Integrate vertically
\beq
  \sum_{k=1}^{N} S_{ijk} \Delta zt_k   = - 0.5   r \sum_{k=1}^{N}  \Delta zt_k  ( u_{i,j,k}^2 + u_{i-1,j,k}^2 + v_{i,j,k}^2 + v_{i,j-1,k}^2)
\eeq
Integrate also on $W$ grid
\beq
 0.5 \Delta zw_0 S_{ij1} + \sum_{k=1}^{N-1} 0.5(S_{ijk} +S_{i,j,k+1}) \Delta zw_k  + 0.5 \Delta zw_N S_{ijN}
  \\ =0.5 S_{ij,1} (\Delta zw_0+\Delta zw_1) + 0.5  \sum_{k=2}^{N-1} S_{ijk}( \Delta zw_k  
  +\Delta zw_{k-1} ) 
   +0.5 S_{i,j,N} (\Delta zw_{N-1}   +  \Delta zw_N) =\sum_{k=1}^{N} S_{ijk} \Delta zt_k 
\eeq
with $zw_k = (zt_{k+1} + zt_k)/2 $ and $ \Delta zw_{k} = zt_{k+1} - zt_{k}$
and $\Delta zt_k = zw_k - zw_{k-1}= (zt_{k+1}  - zt_{k-1})/2$
and $ 0.5( \Delta zw_{k} +  \Delta zw_{k-1}) = 0.5(zt_{k+1}  - zt_{k-1}) = \Delta zt_k$.
It is thus adequate to add
\beq
- 0.5 \frac{\Delta zw_0}{\Delta zw_1} S_{ij1}   -0.5 ( S_{ij1}  + S_{i,j,2}) ~\mbox{for}~k=1
 ~,~
 -0.5 (S_{ijk} + S_{i,j,k+1}) ~\mbox{for}~k=2,N-1~,~ -  S_{ijN}~\mbox{for}~k=N
\eeq
in the TKE equation as forcing, since we do not want to integrate $k=0$ for TKE.


\subsubsection{Lateral dissipation}
  
 For the lateral friction terms $u \vn A \cdot \vn{} u = \vn{} \cdot A \vn{} u^2/2 - A (\vn{} u)^2  $ we consider
 \beq
   \vn A \cdot \vn{} u = (F^x_{ij} - F^x_{i-1,j})/(\cos \phi t_j \Delta xu_i) +  (F^y_{i,j} - F^y_{i,j-1})/(\cos \phi t_j \Delta yt_j)
 \eeq
 with
 \beq
  F^x_{ij} = A_{ij} (u_{i+1,j}-u_{i,j})/(\cos \phi t_j \Delta xt_{i+1})
  ~,~ F^y_{i,j}=A_{ij} (u_{i,j+1}-u_{i,j} )/\Delta yu_j \cos \phi u_j
 \eeq
 and thus
 \beq
 u_{ij} (F^x_{ij} - F^x_{i-1,j}) =
 \\   A_i u_{ij}  (u_{i+1,j}-u_{i,j})/(\cos \phi t_j \Delta xt_{i+1}) 
- A_{i-1} u_{ij} (u_{i,j}-u_{i-1,j})/(\cos \phi t_j \Delta xt_{i})
  =
 \\
0.5 ( A_i  (u_{i+1,j}^2-u_{i,j}^2)/(\cos \phi t_j \Delta xt_{i+1}) 
- A_{i-1} (u_{i,j}^2-u_{i-1,j}^2)/(\cos \phi t_j \Delta xt_{i}))
 \\ 
 -  0.5 A_i  u_{i+1,j}^2/(\cos \phi t_j \Delta xt_{i+1})+ A_i u_{ij} u_{i+1,j}/(\cos \phi t_j \Delta xt_{i+1})
  - 0.5   A_i  u_{i,j}^2/(\cos \phi t_j \Delta xt_{i+1})
  \\
  - 0.5 A_{i-1} u_{i,j}^2(\cos \phi t_j \Delta xt_{i})
 - 0.5 A_{i-1}u_{i-1,j}^2/(\cos \phi t_j \Delta xt_{i})
 + A_{i-1} u_{ij} u_{i-1,j}/(\cos \phi t_j \Delta xt_{i})
 \\ u_{ij} (F^x_{ij} - F^x_{i-1,j}) /(\cos \phi t_j \Delta xu_i)   =\px{}  A \px{} u^2/2 
\\ - 0.5 (    u_{i+1,j} -  u_{ij}  )F_{ij}^x /(\cos \phi t_j \Delta xu_i)
  - 0.5 (   u_{ij}  -  u_{i-1,j}  )  F_{i-1,j}^x  /(\cos \phi t_j \Delta xu_i)
 \eeq
and  for $F^y_{ij}$ 
\beq
u_{ij} (F^y_{i,j} - F^y_{i,j-1})=
u_{ij} ( A_{ij} (u_{i,j+1}-u_{i,j} )/\Delta yu_j \cos \phi u_j - A_{i,j-1} (u_{i,j}-u_{i,j-1} )/\Delta yu_{j-1} \cos \phi u_{j-1}
\\
u_{ij} (F^y_{ij} - F^y_{i,j-1}) /(\cos \phi t_j \Delta yt_j)   =\py{}  A \py{} u^2/2 
\\ - 0.5 (    u_{i,j+1} -  u_{ij}  )F_{ij}^y /(\cos \phi t_j \Delta yt_j)
  - 0.5 (   u_{ij}  -  u_{i,j-1}  )  F_{i,j-1}^y  /(\cos \phi t_j \Delta yt_j)
\eeq


so that
 \beq
 A (\vn{} u)^2 &=& 0.5 \Bar{ (  u_{i+1,j} -u_{i,j}  )  F^x_{ij} 
   +(  u_{i,j} -u_{i-1,j}   )   F^x_{i-1,j}   }^i /(\cos \phi t_j \Delta xu_i) 
   \\
    &&+0.5 \Bar{ (  u_{i,j+1} -u_{i,j}  )  F^y_{ij} 
   +(  u_{i,j} -u_{i,j-1}   )   F^y_{i,j-1}   }^i /(\cos \phi t_j \Delta yt_j)  > 0
 \eeq
 and for $v$ with
 \beq
 \vn A \cdot \vn{} v =
  (F^x_{ij} - F^x_{i-1,j})/(\cos \phi u_j \Delta xt_i) +  (F^y_{i,j} - F^x_{i,j-1})/(\cos \phi u_j \Delta yu_j)
  \\      F^x_{ij} = A_i (u_{i+1,j}-u_{i,j})/(\cos \phi u_j \Delta xu_{i})
   ~,~ F^y_{i,j}=A_i (u_{i,j+1}-u_{i,j} )/\Delta yt_{j+1} \cos \phi t_{j+1}
  \eeq
 yields
  \beq
 A (\vn{} v)^2 &=& 0.5 \Bar{ (  v_{i+1,j} -v_{i,j}  )  F^x_{ij} 
   +(  v_{i,j} -v_{i-1,j}   )   F^x_{i-1,j}   }^i /(\cos \phi u_j \Delta xt_i) 
   \\
    &&+0.5 \Bar{ (  v_{i,j+1} -v_{i,j}  )  F^y_{ij} 
   +(  v_{i,j} -v_{i,j-1}   )   F^y_{i,j-1}   }^i /(\cos \phi u_j \Delta yu_j)  > 0
\eeq
For free slip fluxes are simply zero at the boundaries, for no-slip things are more complicated.
Vertical interpolation on $W$ grid as for Rayleigh friction.

\subsection{Biharmonic friction}

Biharmonic friction is given by
\beq
 \pt u = ... - \vn \cdot A^{1/2} \vn  \vn \cdot A^{1/2} \vn u 
\eeq
and similar for $v$.
Its effect on energy is given by
\beq
u \pt u = ... -  \vn  \cdot \lk u A^{1/2} \vn  \vn \cdot A^{1/2} \vn u \rk  + A^{1/2} \vn \lk  \vn \cdot A^{1/2} \vn u \rk \cdot \vn u
\eeq
Now with %$\vn \cdot a A \vn u = a \vn \cdot A  \vn u + (\vn a) \cdot A \vn u$ or 
%$ (\vn a) \cdot A \vn u = \vn \cdot a A \vn u   - a \vn \cdot A  \vn u  $  or 
%
 $ A^{1/2} (\vn  \lk  \vn \cdot A^{1/2} \vn u \rk  ) \cdot  \vn u =   
 \vn \cdot   \lk  \vn \cdot A^{1/2} \vn u \rk   A^{1/2} \vn u - \lk  \vn \cdot A^{1/2} \vn u \rk^2  $ 
\beq
u \pt u = ... -  \vn  \cdot \left[  u A^{1/2} \vn  \lk \vn \cdot A^{1/2} \vn u \rk  - \lk  \vn \cdot A^{1/2} \vn u \rk   A^{1/2} \vn u  \right] - 
 \lk  \vn \cdot A^{1/2} \vn u \rk^2  
\eeq
The last term is sign-definite and the dissipation rate by biharmonic friction.

\subsubsection{Buoyancy work}


Pressure work is
\beq
 B=   - \Bar{ u_{ij} (p_{i+1,j}-p_{i,j} )/( \Delta xu_i \cos \phi t_j ) }^i
    - \Bar{ v_{ij} (p_{i,j+1}-p_{ij} )/ \Delta yu_j  }^j
\eeq
and for 
\beq  - \v u \cdot \vn p = - \vn \cdot (\v u p) + p \vn \cdot \v u =  - \vn \cdot (\v u p)  - p \pz w 
=  - \vn \cdot (\v u p)  -  \pz{} p w  + w \pz{} p 
\eeq
we get  for $ \vn \cdot (\v u p) $
\beq
 (F_{ij}^x  - F_{i-1,j}^x)/(\Delta xt_i \cos \phi t_j ) + (F_{ij}^y  - F_{i,j-1}^y)/(\Delta yt_j \cos \phi t_j ) 
\eeq
with 
\beq
 F_{ij}^x = (p_{ij}+p_{i+1,j})/2 u_{ij} ~~,~~F_{ij}^y = (p_{ij}+p_{i,j+1})/2 v_{ij} \cos \phi u_j
\eeq
Continuity equation is given by
\beq
(w_k - w_{k-1})/\Delta zt_k
+ (u_{i,j,k}-u_{i-1,j,k} )/(\cos \phi t_j \Delta xt_i) 
               +(\cos \phi u_j v_{i,j,k}-\cos \phi u_{j-1} v_{i,j-1,k} )/(\cos \phi t_j \Delta yt_j ) = 0
\eeq
Simpler for constant $\Delta x$, $\Delta y$
\beq
 \v u \cdot \vn p &=&    \Bar{ u_{ij} \frac{ (p_{i+1,j}-p_{i,j} )}{ \Delta x }  }^i
    + \Bar{ v_{ij} \frac{(p_{i,j+1}-p_{ij} )}{ \Delta y} }^j
    \\ &=& 
     0.5 u_{ij} \frac{ (p_{i+1,j}-p_{i,j} )}{ \Delta x } +  0.5 u_{i-1,j} \frac{ (p_{i,j}-p_{i-1,j} )}{ \Delta x } 
     +0.5 v_{ij} \frac{(p_{i,j+1}-p_{ij} )}{ \Delta y} + 0.5 v_{i,j-1} \frac{(p_{i,j}-p_{i,j-1} )}{ \Delta y}
     \\ &=& 
      0.5 u_{ij} \frac{ (p_{i+1,j}+p_{i,j} )}{ \Delta x } -  0.5 u_{i-1,j} \frac{ (p_{i,j}+p_{i-1,j} )}{ \Delta x } 
      -  u_{ij} \frac{ p_{i,j} }{ \Delta x }  +  u_{i-1,j} \frac{ p_{i,j}}{ \Delta x }  + ...
      \\ &=& \vn \cdot (\v u p)  + p_{ij} (w_k - w_{k-1})/\Delta zt_k 
      \eeq
      When we sum the last term over $k$
   \beq
    \sum_{k=1}^{N_z}  \Delta zt_k p_{k} (w_k - w_{k-1})/\Delta zt_k  =
     \sum_{k=1}^{N_z}  p_{k} w_k - \sum_{k=2}^{N_z} p_{k} w_{k-1}
     %=   \sum_{k=1}^{N_z}  p_{k} w_k - \sum_{k=1}^{N_z-1} p_{k+1} w_{k}
     = p_N w_N +  \sum_{k=1}^{N_z-1}  (p_{k}  - p_{k+1} ) w_{k}
     %=  \sum_{k=2}^{N_z}   p_{k} (w_k - w_{k-1})
   \eeq   
      or we write
      \beq 
       \v u \cdot \vn p &=& 
       \vn \cdot (\v u p)  + ( 0.5(p_{k+1}+p_{k}) w_k - 0.5(p_{k}+p_{k-1}) w_{k-1} )/\Delta zt_k
     \\ &&  + ( -0.5 (p_{k+1}- p_k ) w_k  - 0.5 (  p_{k}  -  p_{k-1}) w_{k-1} )/\Delta zt_k
\eeq
now use $\pz p = - g \rho /\rho_0$,  or $(p_{k+1}-p_{k})/\Delta zw_k = - 0.5 g (\rho_k+\rho_{k+1})/\rho_0$
\beq
 \v u \cdot \vn  p &=& \vn \cdot (\v up)  + \pz{} (p w)   
 +0.25 g/\rho_0 (    \frac{\Delta zw_k}{\Delta zt_k} (\rho_{k+1}+ \rho_k ) w_k  
 +  \frac{\Delta zw_{k-1}}{\Delta zt_k}  (  \rho_{k}  +  \rho_{k-1}) w_{k-1} )  
\eeq


With $ \vn \cdot (\v u p) $
\beq
 (F_{ij}^x  - F_{i-1,j}^x)/(\Delta x ) + (F_{ij}^y  - F_{i,j-1}^y)/(\Delta y ) 
 \\ = 0.5 ( (p_{i+1,j}+p_{i,j}) u_{ij}  -  (p_{i,j}+p_{i-1,j}) u_{i-1j} )/\Delta x
 + 0.5 (   (p_{ij}+p_{i,j+1}) v_{ij}   - (p_{i,j-1}+p_{i,j}) v_{i,j-1}  ) /\Delta y 
\eeq
with 
\beq
 F_{ij}^x = 0.5 (p_{i+1,j}+p_{i,j}) u_{ij} ~~,~~F_{ij}^y = 0.5 (p_{ij}+p_{i,j+1}) v_{ij} 
\eeq
and with $\vn \cdot \v  u$
\beq
 (u_{i,j,k}-u_{i-1,j,k} )/ \Delta x 
               +( v_{i,j,k}- v_{i,j-1,k} )/ \Delta y = -(w_k - w_{k-1})/\Delta zt_k
\eeq

  \subsection{Discrete potential energy and dynamic enthalpy}
 

   \subsubsection{Potential energy} 
 Potential energy $P=g\rho z /\rho_0 $ is given by
 \beq
 \pt{P}+ \vn \cdot \v u P =  g \dt{\rho} z/\rho_0  + g \rho w/\rho_0  
 = \pz{}  (g  /\rho_0  K_v z \pz{} \rho)  -  g/\rho_0 K_v \pz{} \rho  + g \rho w/\rho_0 
 \eeq
 With non-linear equation of state we have
  \beq
 \dt{P} =  \frac{g}{\rho_0} (z \rho_T \pz{} K \pz{T} + z\rho_S \pz{} K \pz{S} )  + g \rho w/\rho_0  
 - g^2 z  \rho_p   w 
  \eeq
 The term $- g^2 z  \rho_p   w $ results from advection since
 \beq
 \rho_T  \pt \theta +  \rho_T \v u \cdot \vn \theta +
  \rho_S \pt S + \rho_S  \v u \cdot \vn S &=& \rho_S \pz{}  (  K  \pz{} S)  + \rho_T \pz{}   (  K  \pz{} \theta) 
  \\ &=& \dt \rho - \rho_p \dt p 
 \eeq	
with
\beq
 \dt \rho = \rho_T \dt \theta + \rho_S \dt S + \rho_p \dt p 
\eeq
 It is an exchange with mean dynamic internal energy and drops for dynamic enthalpy. The right hand side 
 can be written as
  \beq
 \dt{P} &=&  \frac{g}{\rho_0} ( \pz{} z \rho_T K \pz{T} +\pz{}  z\rho_S  K \pz{S} ) 
 -\frac{g}{\rho_0} K (   \rho_T \pz T +   \rho_S \pz{S}  )
 \\ && 
 -\frac{g}{\rho_0} z K (  \pz{T}  \pz{} \rho_T    +   \pz{S} \pz{}  \rho_S  )
 + g \rho w/\rho_0   - g^2 z  \rho_p   w 
% \\
% &=& \pz{}  (g  /\rho_0  K_v z \pz{} \rho)  -  g/\rho_0 K_v \pz{} \rho  + g \rho w/\rho_0 
 % -  g/\rho_0 K_v ( \pz{T} )\pz{ \rho_T}  -  g/\rho_0 K_v ( \pz{S} )\pz{ \rho_S}
 \eeq
The first term is a flux, the second the usual exchange with TKE, the third term is cabelling.
 For the equation of state by Vallis it becomes negative (see below).
 
   \subsubsection{Dynamic enthalpy}
 
 For an incompressible equation of state dynamic enthalpy $H_d = - g \int_z^0 \rho(S,\theta,z') /\rho_0 dz' $
is identical to potential energy, since $\rho$ does not depend on $z$
\beq
 H_d = - g \rho(S,\theta)/\rho_0  \int_z^0 dz' = g \rho z/\rho_0  = P
\eeq
With compressibility we find
\beq \nonumber
    \rho_0 \Bar{\dt{}}  H_d(S,\theta,z)  &=&  g \rho w - g \tl \rho_T \dt \theta -g  \tl \rho_S   \dt S
   % \\ &=& g \rho w - g \tl \rho_T \pz{} ( K \pz \theta)  -g \tl \rho_S \pz{} (K \pz S)
     \\ &=&  g \rho w -  \pz{} ( g \tl \rho_T K \pz \theta)  - \pz{} (g \tl \rho_S K \pz S)
      + g K \pz \theta \pz{} \tl \rho_T + g K \pz S \pz{} \tl \rho_S
       - g \tl \rho_T \dot \theta - g \tl \rho_S \dot S
      \\
        \Bar{\dt{}}  H_d(S,\theta,z)  &=& 
           \frac{g \rho}{\rho_0} w +  \pz{} (  H_T K \pz \theta)  + \pz{} (H_S K \pz S)
      -  K \pz \theta \pz{} H_T - K \pz S \pz{} H_S
      +H_T \dot \theta +H_S \dot S
 \eeq
with $\tl \rho_T = \int_{z}^0 \rho_T(S,\theta,z')  dz' = - (\rho_0/g) \p H_d /\p \theta$. 
Using 
\beq 
\pz{} \tl \rho |_{x,y} &=&  \pz{} \tl \rho |_{S,H} + \frac{\p \tl \rho}{\p \theta} |_{S,z} \pz \theta
+ \frac{\p \tl \rho}{\p S} |_{\theta,z} \pz S
=- \rho + \tl \rho_\theta   \pz \theta + \tl \rho_S \pz S
\eeq
The exchange terms become
\beq
 K \pz \theta \pz{} \tl \rho_T +  K \pz S \pz{} \tl \rho_S
= -\rho_TK \pz \theta  -\rho_S K \pz S 
 + \tl \rho_{TT} K (\pz \theta)^2  + 2  \tl \rho_{TS} K (\pz S)  (\pz \theta  )  + \tl \rho_{SS} K (\pz S)   
\eeq
The first two are the usual exchange with TKE, the remaining three are cabbeling terms.
For the equation of state by Vallis (2006), only the first of the cabellling terms is active and
$ \tl \rho_{TT} K (\pz \theta)^2 <0 $  since $\rho_{TT} =- \rho_0 \beta_{T}^\star <0$.

 \subsubsection{Exchange of potential energy with TKE for a linear equation of state}
 
  On a discrete level this becomes
  \beq
 \pz{} K_v \pz{} \rho =  (F^{\rho}_{k} - F^{\rho}_{k-1} ) /\Delta zt_k
~~,~~
 F^\rho_{k} = K^v_{k} (\rho_{k+1}- \rho_{k})/\Delta zw_k
 \\
  z\pz{} K_v \pz{} \rho =
 zt_k (  F^{\rho}_{k} - F^{\rho}_{k-1} ) /\Delta zt_k 
 \\ =   (  (zt_k+zt_{k+1})/2  F^{\rho}_{k} - (zt_k+zt_{k-1})/2 F^{\rho}_{k-1} ) /\Delta zt_k 
 \\  
 + (  zt_k/2  F^{\rho}_{k} - zt_k/2 F^{\rho}_{k-1} ) /\Delta zt_k 
 - (  zt_{k+1}/2  F^{\rho}_{k} - zt_{k-1}/2 F^{\rho}_{k-1} ) /\Delta zt_k
 %
 \\ =  ( zw_k  F^{\rho}_{k} - zw_{k-1} F^{\rho}_{k-1} ) /\Delta zt_k   
 - (    \Delta zw_{k}   F^{\rho}_{k} +  \Delta zw_{k-1} F^{\rho}_{k-1} ) /(2\Delta zt_k)
\eeq
with $zw_k = (zt_{k+1} + zt_k)/2 $ and $ \Delta zw_{k} = zt_{k+1} - zt_{k}$.
The second term is the exchange with TKE, the first is a flux divergence. 
Integrating the second term over $z$
\beq
0.5  \sum_{k=1}^{N} (    \Delta zw_{k}   F^{\rho}_{k} +  \Delta zw_{k-1} F^{\rho}_{k-1} )
=0.5  \sum_{k=1}^{N}     \Delta zw_{k}   F^{\rho}_{k}  + 0.5 \sum_{k=2}^{N} \Delta zw_{k-1} F^{\rho}_{k-1}
= 0.5   \Delta zw_{N}   F^{\rho}_{N} + \sum_{k=1}^{N-1} \Delta zw_{k} F^{\rho}_{k}
\eeq
and the first also
\beq
 \sum_{k=1}^{N}( zw_k  F^{\rho}_{k} - zw_{k-1} F^{\rho}_{k-1} )
 =  \sum_{k=1}^{N} zw_k  F^{\rho}_{k} -  \sum_{k=1}^{N-1}  zw_{k} F^{\rho}_{k} = zw_N  F^{\rho}_{N} =0
\eeq
since $zw_N=0$.
Check by summing
\beq
 \sum_{k=1}^{N}  zt_k (  F^{\rho}_{k} - F^{\rho}_{k-1} ) =  
 zt_N  F^{\rho}_{N} - \sum_{k=1}^{N-1}  \Delta zw_k  F^{\rho}_{k} 
\eeq
The forcing which enters the TKE equation defined on $W$ grid is then simply
\beq
  F^{\rho}_{k} ~\mbox{for} ~k=1,N-1~~,~~  F^{\rho}_{N}~\mbox{for} ~k=N
\eeq
It is possible that the surface density flux $F^{\rho}_{N}$ drains out the TKE at the surface.
This is because we need to mix the first layer, and this energy has to be taken from somewhere.
We need to increase the TKE forcing or to reduce the surface density flux in such a case.


\subsubsection{Exchange of potential energy with TKE for a nonlinear equation of state}

With a nonlinear equation of state we have
 \beq
   z \rho_T \pz{} K \pz{} T  =
 zt_k (\rho_T)_k  (  F^{T}_{k} - F^{T}_{k-1} ) /\Delta zt_k  
 \\ =   (  (zt_k (\rho_T)_k +zt_{k+1} (\rho_T)_{k+1} )/2  F^{T}_{k} 
  - (zt_k(\rho_T)_k +zt_{k-1}(\rho_T)_{k-1})/2 F^{T}_{k-1} ) /\Delta zt_k 
 \\  
 + (  zt_k (\rho_T)_k /2  F^{T}_{k} - zt_k (\rho_T)_k  /2 F^{T}_{k-1} ) /\Delta zt_k 
 - (  zt_{k+1} (\rho_T)_{k+1} /2 F^{T}_{k} - zt_{k-1} (\rho_T)_{k-1} /2 F^{T}_{k-1} ) /\Delta zt_k
\eeq
and similar for $S$.
 The first term is a flux which integrates to zero, since
 \beq
0.5  \sum_{k=1}^N  (  (zt_k (\rho_T)_k +zt_{k+1} (\rho_T)_{k+1} )  F^{T}_{k} 
  - (zt_k(\rho_T)_k +zt_{k-1}(\rho_T)_{k-1}) F^{T}_{k-1} ) = 
  \\ 
  0.5     (zt_N (\rho_T)_N +zt_{N+1} (\rho_T)_{N+1} )  F^{T}_{N}  = zw_N  (\rho_T)_N  F^{T}_{N} = 0
 \eeq
 for $\p \rho_T/\p p = 0$. For compressible equation of state there is a flux.
  The second can be written as
\beq
  -(    zt_{k+1} (\rho_T)_{k+1} - zt_k (\rho_T)_k )  F^{T}_{k} /(2 \Delta zt_k) 
  -(  zt_k (\rho_T)_k  - zt_{k-1} (\rho_T)_{k-1} )  F^{T}_{k-1}  /(2\Delta zt_k)
\eeq
Integrate over z
\beq
 -0.5 \sum_{k=1}^N   (  zt_{k+1} (\rho_T)_{k+1} - zt_k (\rho_T)_k )  F^{T}_{k} 
-0.5  \sum_{k=1}^N  (  zt_k (\rho_T)_k  - zt_{k-1} (\rho_T)_{k-1} )  F^{T}_{k-1}
\\
= -0.5  (\rho_T)_N  \Delta   zw_N    F^{T}_{N} 
-  \sum_{k=1}^{N-1}  (  zt_{k+1} (\rho_T)_{k+1}  - zt_{k} (\rho_T)_{k} )  F^{T}_{k}
\eeq
The forcing which enters the TKE equation defined on $W$ grid is then 
\beq
  \frac{(  zt_{k+1} (\rho_T)_{k+1}  - zt_{k} (\rho_T)_{k} ) }{\Delta zw_k} 
   F^{T}_{k}  ~\mbox{for} ~k=1,N-1~~,~~  (\rho_T)_N  F^{T}_{N}~\mbox{for} ~k=N
\eeq

\subsubsection{Exchange of dynamic enthalpy with TKE}

With compressibility we find
\beq \nonumber
    \rho_0 \Bar{\dt{}}  H_d(S,\theta,z)  &=&  %g \rho w + g \rho_0  \tl \alpha \dt \theta -g \rho_0 \tl \beta   \dt S= 
     g \rho w - g \tl \rho_T \pz{} ( K \pz \theta)  -g \tl \rho_S \pz{} (K \pz S)
     \\ &=& 
      g \rho w -  \pz{} ( g \tl \rho_T K \pz \theta)  - \pz{} (g \tl \rho_S K \pz S)
      + g K \pz \theta\pz{} \tl \rho_T 
      + g K \pz S  \pz{} \tl \rho_S
 \eeq
with $\tl \rho_T = \int_{z}^0 \rho_T(S,\theta,z')  dz'$. On a discrete level this becomes
\beq
    \tl \rho_T \pz{} K \pz{} T  &=&
 (\tl \rho_T)_k  (  F^{T}_{k} - F^{T}_{k-1} ) /\Delta zt_k  
 \\ &=&   (  ((\tl \rho_T)_k + (\tl \rho_T)_{k+1} )/2  F^{T}_{k} 
  - ((\tl \rho_T)_k +(\tl \rho_T)_{k-1})/2 F^{T}_{k-1} ) /\Delta zt_k 
 \\  &&
 -0.5 [  (\tl \rho_T)_{k+1}  -    (\tl \rho_T)_{k} ]  F^{T}_{k}  /\Delta zt_k
  - 0.5 [ (\tl \rho_T)_{k}   -  (\tl \rho_T)_{k-1}  ] F^{T}_{k-1}  \Delta zt_k  
\eeq
and similar for $S$. The first term is  a flux, the second the exchange with TKE.
Integrating the flux term over depth yields
\beq
0.5   \sum_{n=1}^N [    ((\tl \rho_T)_k + (\tl \rho_T)_{k+1} )  F_{k} 
  - ((\tl \rho_T)_k +(\tl \rho_T)_{k-1}) F_{k-1} ]  
   \\ = 0.5   \sum_{n=1}^N     ((\tl \rho_T)_k + (\tl \rho_T)_{k+1} )  F_{k} 
  -0.5   \sum_{n=1}^{N-1}    ((\tl \rho_T)_{k+1} +(\tl \rho_T)_{k}) F_{k}
  = 0.5     ((\tl \rho_T)_N + (\tl \rho_T)_{N+1} )  F_{N}
\eeq
which only vanishes if $\p \rho /\p p=0$.
Integrating the second over depth yields
\beq
  -0.5 \sum_{n=1}^N [  (\tl \rho_T)_{k+1}  -    (\tl \rho_T)_{k} ]  F^{T}_{k}  
  - 0.5 \sum_{n=2}^N [ (\tl \rho_T)_{k}   -  (\tl \rho_T)_{k-1}  ] F^{T}_{k-1}   
 \\ = 
  -0.5 [  (\tl \rho_T)_{N+1}  -    (\tl \rho_T)_{N} ]  F^{T}_{N}  
  - \sum_{n=1}^{N-1} [  (\tl \rho_T)_{k+1}  -    (\tl \rho_T)_{k} ]  F^{T}_{k}  
 \eeq
The forcing which enters the TKE equation defined on $W$ grid is then 
\beq
 - \frac{ (\tl \rho_T)_{k+1}  - (\tl \rho_T)_{k}  }{\Delta zw_k} 
   F^{T}_{k}  ~\mbox{for} ~k=1,N-1~~,~~  
   -\frac{ [  (\tl \rho_T)_{N+1}  -    (\tl \rho_T)_{N} ]  F^{T}_{N} }{ \Delta zw_N} ~\mbox{for} ~k=N
\eeq
At the surface, the flux contribution adds  to
\beq
 \frac{ 
    2 (\tl \rho_T)_N    F_{N}
}{ \Delta zw_N} ~\mbox{for} ~k=N
\eeq

\subsubsection{Exchange with TKE by horizontal diffusion}

Horizontal diffusion of $T$ and $S$ also affects potential energy for a non-linear equation
of state. 
 \beq
 \px{} K \px{} T =  (F_{i} - F_{i+1} ) /\Delta xt_i
~~,~~
 F_{i} = K_{i} (T_{i+1}- T_{i})/\Delta xu_i
 \\
 \rho_T z\px{} K \px{} T 
 = (\rho_T)_i  z (F_{i} - F_{i+1} ) /\Delta xt_i
 \\ =  z  (  ( (\rho_T)_i + (\rho_T)_{i+1} )/2  F_{i} 
  - z ((\rho_T)_i + (\rho_T)_{i-1})/2 F_{i-1} ) /\Delta xt_i 
 \\  
 + z (  (\rho_T)_i /2  F_{i} - (\rho_T)_i  /2 F_{i-1} ) /\Delta xt_i 
 - z ( (\rho_T)_{i+1} /2 F_{i} -  (\rho_T)_{i-1} /2 F_{i-1} ) /\Delta xt_i
  \eeq
and similar for $S$. The first term is a flux divergence and integrates to zero. The second
term can be written as
\beq
   - z ( (\rho_T)_{i+1}   -   (\rho_T)_i  )  F_{i} /(2\Delta xt_i)   
  - z  ( (\rho_T)_i  -  (\rho_T)_{i-1}  ) F_{i-1}  /(2 \Delta xt_i)
  \eeq
This forcing has to be interpolated to the $W$ grid as for the frictional terms. The sign of the forcing
\beq
 \rho_T z\px{} K \px{} T 
 = \px{} (\rho_T z K \px{} T) - z  K \px{} T \px{} \rho_T
 =  \px{} (\rho_T z K \px{} T) - z  K (\px{} T)^2 \rho_{TT} 
\eeq
depends on the sign of $\rho_{TT} $.
For the equation of state by Vallis (2006) we have  $ \rho_{TT} =   -  \rho_0 \beta_{Ts} <0 $ and thus
\beq
 - z  K (\px{} T)^2 \rho_{TT}  <0
\eeq
It is thus always a forcing of TKE.


 \subsubsection{Exchange by isopycnal diffusion}


The isopycnal diffusion operator in small slope approximation is given by
\beq
 \pt{} T &=& ... + \vn \cdot \v K \vn T
\eeq
with
\beq
 \v K &=&  K_{iso} \left( 
 \begin{array} {ccc}
  1 & 0 & s_x \\
  0 & 1 & s_y \\
  s_x & s_y & s_x^2 + s_y^2 
 \end{array} \right)
  + K_{gm}  \left(
   \begin{array} {ccc}
  0 & 0 & -s_x \\
  0 & 0 & -s_y \\
  s_x & s_y &  0
 \end{array} \right)
\eeq
with the isopycnal slopes $s_x = - \px \rho/\pz \rho $ and $s_y -\py \rho /\pz \rho$. 
The effect of dynamic enthalpy is given by
\beq \nonumber
    \rho_0 \Bar{\dt{}}  H_d(S,\theta,z)  &=&  
     g \rho w - g \tl \rho_T \vn \cdot \v K \vn \theta   -g \tl \rho_S \vn \cdot \v K \vn S 
 \eeq
The isopycnal mixing part can be treated as for horizontal fluxes and  vertical mixing.
This also holds for skew the diffusion.
The discrete functional for the flux $\v K \vn T$ by Griffies et al is used for isopycnal mixing
and skew diffusion. The vector streamfunction $\v B$ for the eddy driven velocity $\vn \times \v B$ 
is given by
\beq
  \v B = \Vec{ - K_{gm} s_y \\  K_{gm} s_x \\ 0 } ~~,~~\vn \times \v B =
  \Vec{- \pz{} K_{gm} s_x  \\ - \pz{} K_{gm} s_y \\ \px{} K_{gm} s_x + \py{} K_{gm} s_y }
\eeq

 \subsubsection{Exchange by advective fluxes}
 
Accept for a change in sign, the advective fluxes behave the same as the diffusive ones.
\beq
- \tl \rho_T  \px{} (u T) &=& - \px{} (\tl \rho_T  u T) + u T  \px{} \tl\rho_T 
\\
 -\tl  \rho_T  \px{} (u T) &=& - \frac{(\tl \rho_T)_i   (F_{i} - F_{i+1}) }{ \Delta xt_i}
  =  -   \frac{   ( (\tl \rho_T)_i + (\tl \rho_T)_{i+1} )/2  F_{i} 
  -  ((\tl \rho_T)_i + (\tl \rho_T)_{i-1})/2 F_{i-1} }{ \Delta xt_i} 
 \\  &&
+   \frac{  ((\tl \rho_T)_{i+1}  -  (\tl \rho_T)_i   ) F_{i}
+  ( (\tl \rho_T)_i     -  (\tl\rho_T)_{i-1} ) F_{i-1} }{ 2 \Delta xt_i}
\eeq
where $F_i$ is the advective zonal flux. The first term is a flux which integrates to zero,
the second is an exchange with TKE. For the vertical flux we have
\beq
   - \tl \rho_T \pz{} (w T)  &=& - \pz{} (\tl \rho_T w T) + w T \pz{} \tl \rho_T
   =  - \pz{} (\tl \rho_T w T) + w T( - \rho_T + \tl \rho_{TT}   \pz \theta + \tl \rho_{TS} \pz S)
   \\ &=&
-  (\tl \rho_T)_k  (  F^{T}_{k} - F^{T}_{k-1} ) /\Delta zt_k  
 \\ &=& -  \frac{   ((\tl \rho_T)_k + (\tl \rho_T)_{k+1} )  F^{T}_{k} 
  - ((\tl \rho_T)_k +(\tl \rho_T)_{k-1}) F^{T}_{k-1} } {2 \Delta zt_k} 
 \\  &&
 +\frac{  [  (\tl \rho_T)_{k+1}  -    (\tl \rho_T)_{k} ]  F^{T}_{k} 
  +  [ (\tl \rho_T)_{k}   -  (\tl \rho_T)_{k-1}  ] F^{T}_{k-1}  }{  2 \Delta zt_k}  
\eeq
where $F_k$ is the vertical advective flux. 
 Using 
\beq 
\pz{} \tl \rho |_{x,y} &=& - \rho + \tl \rho_\theta   \pz \theta + \tl \rho_S \pz S
\eeq

 
The equation of potential energy $P=g \rho z/\rho_0$ in the model 
\beq
\pt{} P &=& g \rho w/\rho_0  + \vn \cdot (..)+ K N^2 
+ \lk  -g/\rho_0   \pz{} (z \rho_T)  K \pz \theta  - g/\rho_0 \pz{} (z \rho_S) K \pz S - K N^2 \rk
\\ && 
\\ &&
 - g/\rho_0 z (  \rho_T \vn \cdot (\v u \theta) + \rho_S \vn \cdot (\v u S)
 + \rho_p \vn \cdot (\v u p_0) - \vn \cdot (\v u \rho)  
 )
\eeq 
 The equation of dynamic enthalpy $H=- g/ \rho_0 \int_{z}^0 \rho dz' $ in the model 
 \beq
\pt{} H &=& g \rho w/\rho_0  + \vn \cdot (..) + K N^2 
+ [ g/\rho_0   \pz{} (\tl \rho_T)  K \pz \theta  + g/\rho_0 \pz{} ( \tl \rho_S) K \pz S - K N^2 ]
\\ && 
\\ &&
 -  ( -  g/\rho_0  \tl \rho_T \vn \cdot (\v u \theta) - g/\rho_0  \tl \rho_S \vn \cdot (\v u S)
 + g/\rho_0  \rho w 
  - \vn \cdot (\v u H)  
 )
 \eeq 

\subsubsection{Exchange of potential energy with mean kinetic energy}

Now calculate 
\beq
z(\pt{ \rho } +  \vn \cdot \v u \rho)  + \pz{} w \rho z =z(\pt{ \rho } +  \vn \cdot \v u \rho)  +
0.5 (w_k (\rho_k + \rho_{k+1}) zw_k  - w_{k-1} (\rho_k + \rho_{k-1}) zw_{k-1})/\Delta zt_k 
\\ = z(\pt{ \rho } +  \vn \cdot \v u \rho) + zt_k  0.5 (w_k (\rho_k + \rho_{k+1})  - w_{k-1} (\rho_k + \rho_{k-1}))/\Delta zt_k
\\  -  zt_k  0.25 ( w_k (\rho_k + \rho_{k+1})- w_{k-1} (\rho_k + \rho_{k-1}))/\Delta zt_k
\\ +0.25 (w_k (\rho_k + \rho_{k+1}) zt_{k+1}  - w_{k-1} (\rho_k + \rho_{k-1}) zt_{k-1})/\Delta zt_k 
\\ 
 =z(\pt{ \rho } +  \vn \cdot \v u \rho  + \pz{} w \rho)
\\  +0.25 ( w_k  (\rho_k + \rho_{k+1})\Delta zw_k
                +w_{k-1}  (\rho_k + \rho_{k-1}) \Delta zw_{k-1}  )/\Delta zt_k 
                \\  
g/\rho_0  \dt{P} =g/\rho_0  z \dt{\rho}
                 -0.5    ( w_k  (p_{k+1} - p_k)+w_{k-1}  (p_k - p_{k-1})  )/\Delta zt_k 
\eeq
with $zw_k = (zt_{k+1} + zt_k)/2 $
and $ \Delta zw_k = zt_{k+1} - zt_k$ and with
with $(p_{k+1}-p_{k})/\Delta zw_k = - 0.5 g (\rho_k+\rho_{k+1})/\rho_0$.
 The second term is the exchange with KE. Or different
 \beq
z(\pt{ \rho } +  \vn \cdot \v u \rho)  + \pz{} w \rho z =z(\pt{ \rho } +  \vn \cdot \v u \rho)  +
0.5 (w_k (zt_k \rho_k + zt_{k+1} \rho_{k+1})  - w_{k-1} (zt_k \rho_k + zt_{k-1} \rho_{k-1}))/\Delta zt_k 
\\ = z(\pt{ \rho } +  \vn \cdot \v u \rho) + zt_k  0.5 (w_k (\rho_k + \rho_{k+1})  - w_{k-1} (\rho_k + \rho_{k-1}))/\Delta zt_k
\\+ 0.5 (w_k  zt_{k+1} \rho_{k+1}  - w_{k-1}  zt_{k-1} \rho_{k-1})/\Delta zt_k 
- zt_k  0.5 (w_k  \rho_{k+1}  - w_{k-1}  \rho_{k-1})/\Delta zt_k
\\ = z(\pt{ \rho } +  \vn \cdot \v u \rho  + \pz{} w \rho)
+ 0.5 (w_k  \rho_{k+1}  \Delta zw_k  + \rho_{k-1} w_{k-1}  \Delta zw_{k-1}) /\Delta zt_k 
\eeq
 We integrate over $z$. 
\beq
 g/\rho_0 /4 \sum_{k=1}^{N}  ( w_k  (\rho_k + \rho_{k+1})\Delta zw_k
                +w_{k-1}  (\rho_k + \rho_{k-1}) \Delta zw_{k-1}  )
                 \\ = g/\rho_0 /4 \sum_{k=1}^{N}   w_k  (\rho_k + \rho_{k+1})\Delta zw_k
                 + g/\rho_0 /4 \sum_{k=2}^{N} w_{k-1}  (\rho_k + \rho_{k-1}) \Delta zw_{k-1} 
                = 
                \\ =g/\rho_0 /4   w_N  (\rho_N + \rho_{N+1})\Delta zw_N +
                g/\rho_0 /2  \sum_{k=1}^{N-1}   w_k  (\rho_k+    \rho_{k+1}) \Delta zw_k
               \\ =   -    w_N  (p_s-p_N)  -    \sum_{k=1}^{N-1} w_k (p_{k+1}  -   p_k)  
             \eeq
 Or different
 \beq
   g/\rho_0    \sum_{k=1}^N    0.5 (w_k  \rho_{k+1}  \Delta zw_k  + \rho_{k-1} w_{k-1}  \Delta zw_{k-1})
   =   
   g/\rho_0   0.5 w_N  \rho_{N+1}  \Delta zw_N 
   +
   g/\rho_0    \sum_{k=1}^{N-1}    0.5 w_k(  \rho_{k+1} 
   +   \rho_{k})  \Delta zw_{k}
   \eeq
The exchange in the KE budget becomes
\beq
   \sum_{k=1}^{N}   p_{k} (w_k - w_{k-1}) = 
    \sum_{k=1}^{N-1}   p_{k} w_k -  \sum_{k=1}^{N-1}   p_{k+1}  w_{k} 
 =  \sum_{k=1}^{N-1} w_k  (p_k- p_{k+1})
 =   0.5 g/\rho_0 \sum_{k=1}^{N-1} w_k    (\rho_k+\rho_{k+1}) \Delta zw_k 
\eeq
with $(p_{k+1}-p_{k})/\Delta zw_k = - 0.5 g (\rho_k+\rho_{k+1})/\rho_0$,
and is thus identical.

\subsubsection{Exchange of dynamic enthalpy with mean kinetic energy}

For dynamic enthalpy $H=-g/\rho_0 \int_z^0 \rho dz'$ we have
\beq
 \rho_0 \dt H &=&  g \rho \dt{z} - g \tl \rho_T \dt T - g \tl \rho_S \dt S = g \rho w - g \tl \rho_T \dt T - g \tl \rho_S \dt S 
\eeq
On a discrete level this becomes
\beq
 \pz{} (H w) = 0.5 ( w_k (H_{k+1}+H_k)  - w_{k-1} (H_{k}+H_{k-1}) )/\Delta zt_k    
\eeq

\subsection{TKE equation and vertical mixing} 


The TKE equation is given by
\beq
\pt{} E = \pz{} \kappa_{e} \pz{} E - c_\epsilon  E^{3/2} /L  - N^2 \kappa_h  + \kappa_m (\pz{} \v u_h)^2 + A_h (\vn \v u_h)^2
\eeq
with $\kappa_m = c_k L E^{1/2} $, $\kappa_e=\alpha_{tke} \kappa_m$
 and $\kappa_h =\kappa_m /P_r$ with  $P_r = 6.6 Ri $ and $1 <= Pr <= 10$.
 
 \subsubsection{TKE at $W$ points}
 
 
  TKE $E$ is defined at $W$ points. Similar for EKE and internal wave energy.
 Both vertical diffusion of $E$ and dissipation are treated implicitly.
Discrete form is given by
\beq
 (E_k^n - E_k^{n-1})/\Delta t =    (F_k - F_{k-1}) / \Delta zw_{k} -  c_\epsilon E_k^n (E_k^{n-1})^{1/2} /L
  + P_k
\eeq
 with $F_k =  \kappa_k (E_{k+1}^n-E_k^n)/\Delta zt_{k+1}$ and $\kappa_k = 0.5((\kappa_e)_{k+1}+(\kappa_e)_k)$,
 and $P_k$ forcing from dissipation and buoyancy work. 
   Rewrite as
 \beq
   E_k^n (1 + c_\epsilon\Delta t (E_k^{n-1})^{1/2} /L)
   -  (E_{k+1}^n-E_k^n) \frac{\kappa_k  \Delta t}{ \Delta zt_{k+1} \Delta zw_{k}}  
    + (E_{k}^n-E_{k-1}^n) \frac{\kappa_{k-1} \Delta t}{\Delta zt_{k} \Delta zw_{k}} 
    = E_k^{n-1}   + P_k \Delta t
 \eeq
 or
\beq
 A_k E_{k-1}^n +  B_k E_k^n + C_k E_{k+1}^n  = E_k^{n-1}   + P_k \Delta t
 \\ C_k =- \frac{\delta_k}{ \Delta zw_{k}}  ~~,~~
  B_k =  1 + c_\epsilon\Delta t (E_k^{n-1})^{1/2}/L +\frac{\delta_k}{\Delta zw_{k}} 
 + \frac{\delta_{k-1}}{ \Delta zw_{k}} 
 ~~,~~ A_k = - \frac{\delta_{k-1}}{ \Delta zw_{k}} 
\eeq
with $\delta_k = \frac{\kappa_k \Delta t}{\Delta zt_{k+1}}$.
At $k=1$, near the bottom we have
\beq
 A_k E_{k-1}^n +  B_k E_k^n + C_k E_{k+1}^n  = E_k^{n-1}   + P_k \Delta t- F_b \Delta t/  \Delta zw_{k} 
 \\ C_k =- \frac{\delta_k}{ \Delta zw_{k}} 
 ~,~ B_k =  1 + c_\epsilon\Delta t (E_k^{n-1})^{1/2}/L +\frac{\delta_k}{\Delta zw_{k}} 
 ~,~ A_k = 0 
\eeq
$F_b$ is the TKE flux at $zt_1=-h+\Delta z_1/2$, which is not at the bottom. 
At $k=N$, near the surface, the $W$ grid box is only half thick. We have 
\beq
 A_k E_{k-1}^n +  B_k E_k^n + C_k E_{k+1}^n  = E_k^{n-1}   + P_k \Delta t+  F_s \frac{ \Delta t}{0.5 \Delta zw_{k}}  
 \\ C_k =0 ~,~
  B_k =  1 + c_\epsilon\Delta t (E_k^{n-1})^{1/2}/L 
 + \frac{\delta_{k-1}}{0.5 \Delta zw_{k}} 
 ~,~ A_k = - \frac{\delta_{k-1}}{0.5 \Delta zw_{k}} 
\eeq
where $F_s$ is the surface flux of TKE. 
 A Dirichlet boundary condition looks like
  \beq
   E_k^n (1 + c_\epsilon\Delta t (E_k^{n-1})^{1/2} /L)
   -  (E_{surf}-E_k^n) \frac{\delta_k}{ 0.5 \Delta zw_{k}}  
    + (E_{k}^n-E_{k-1}^n) \frac{\delta_{k-1}}{0.5 \Delta zw_{k}} 
    = E_k^{n-1}   + P_k \Delta t
 \eeq
\beq
 A_k E_{k-1}^n +  B_k E_k^n + C_k E_{k+1}^n  = E_k^{n-1}   + P_k \Delta t
 +E_{surf} \frac{\delta_{k}}{0.5 \Delta zw_{k}}
 \\ C_k =0 ~,~
  B_k =  1 + c_\epsilon\Delta t (E_k^{n-1})^{1/2}/L 
 + \frac{\delta_{k}}{0.5 \Delta zw_{k}}  + \frac{\delta_{k-1}}{0.5 \Delta zw_{k}} 
 ~,~ A_k = - \frac{\delta_{k-1}}{0.5 \Delta zw_{k}} 
\eeq

 \subsubsection{Advection for tracer at $W$ grid}
 
We advect tracer on the $W$ grid such as TKE with the following
lateral advection velocity
\beq
 U_{i,j,k} &=& 0.5 \Delta zt_{k+1} /\Delta zw_k u_{k+1} + 0.5  \Delta zt_{k} /\Delta zw_{k} u _k   
 \\ 
 U_{i,j,k} &=& 0.5 \Delta zt_{k+1} /\Delta zw_k u_{k+1} +   \Delta zt_{k} /\Delta zw_{k} u _k  ~~,~~k=1
 \\
 U_{i,j,k} &=&  0.5  \Delta zt_{k} /\Delta zw_{k} u _k  ~~,~~k=N
\eeq
and similar for $V$. In case of topography $U$ and $V$ have to be redirected at the bottom.
The vertical velocity is given by continuity
\beq
  W_{i,j,k} = W_{i,j,k-1}  - \Delta zw_k \left( (U_{i,j,k} - U_{i-1,j,k} )/\Delta xt_i - (V_{i,j,k} - V_{i,j-1,k})/\Delta yt_j  \right)
\eeq  
 For $u$ and $v$ it holds from the streamfunction formalism that
 \beq
0=  \sum_{n=1}^N \Delta zt_k \left(  (u_{i,j,k} - u_{i-1,j,k} )/\Delta xt_i + (u_{i,j,k} - u_{i,j-1,k})/\Delta yt_j  \right) = 
  - \sum_{n=1}^N   (w_{i,j,k} - w_{i,j,k-1} )  =   -   w_{i,j,N} 
 \eeq
 suppressing the $\cos$ factors.
The same has to hold for $U$ and $V$
\beq
- \sum_{n=1}^N  \Delta zw_k ( W_k - W_{k-1}) /\Delta zw_k 
= -  \sum_{n=1}^{N} W_k +  \sum_{n=0}^{N-1}  W_{k} =
\\
-W_{i,j,N}= \sum_{n=1}^N   \Delta zw_k (U_{i,j,k}-U_{i-1,j,k})/\Delta xt_i  
  + \sum_{n=1}^N   \Delta zw_k (V_{i,j,k}-V_{i,j-1,k})/\Delta yt_j   &=& 
  \\
   \sum_{n=1}^{N-1} 0.5 (u_{i,j,k+1}- u_{i-1,j,k+1})  \Delta zt_{k+1} /\Delta xt_i    
   +  \sum_{n=1}^N 0.5 (u_{i,j,k}-u_{i-1,j,k}) \Delta zt_k /\Delta xt_i  
 \\   + \sum_{n=1}^{N-1} 0.5 (v_{i,j,k+1}- v_{i,j-1,k+1})  \Delta zt_{k+1} /\Delta yt_j  
   +  \sum_{n=1}^N 0.5 ( v_{i,j,k}-v_{i,j-1,k}) \Delta zt_k /\Delta yt_j  
   \\ 
      +  0.5 (u_{i,j,1}-u_{i-1,j,1}) \Delta zt_1 /\Delta xt_i  
    +  0.5 ( v_{i,j,1}-v_{i,j-1,1}) \Delta zt_1 /\Delta yt_j  
  \\ = 0  \eeq
   

  
%with $ 0.5( \Delta zw_{k} +  \Delta zw_{k-1})  = \Delta zt_k$.  

  \subsubsection{Implicit vertical mixing at $T$ points}
 
 Consider a tracer  $E$ defined at $T$ points such as temperature.
 Vertical diffusion of $E$ is treated implicitly.
Discrete form is given by
\beq
 (E_k^n - E_k^{n-1})/\Delta t =    (F_k - F_{k-1}) / \Delta zt_{k} - I_k E^n_k
  + P_k(E^{n-1})
\eeq
with $F_k =  \kappa_k (E_{k+1}^n-E_k^n)/\Delta zw_{k}$,
 with a parameter $I_k$ and $P_k$ containing other explicit terms. Rewrite as
 \beq
   E_k^n (1 + I_k \Delta t )
   -  (E_{k+1}^n-E_k^n) \frac{\kappa_k  \Delta t}{ \Delta zw_k \Delta zt_{k}}  
    + (E_{k}^n-E_{k-1}^n) \frac{\kappa_{k-1} \Delta t}{\Delta zw_{k-1} \Delta zt_{k}} 
    = E_k^{n-1}   + P_k \Delta t
 \eeq
or
\beq
 A_k E_{k-1}^n +  B_k E_k^n + C_k E_{k+1}^n  = E_k^{n-1}   + P_k \Delta t
 \\ C_k =- \frac{\delta_k}{ \Delta zt_{k}}  ~~,~~
  B_k =  1 + I_k\Delta t +\frac{\delta_k}{\Delta zt_{k}} 
 + \frac{\delta_{k-1}}{ \Delta zt_{k}} 
 ~~,~~ A_k = - \frac{\delta_{k-1}}{ \Delta zt_{k}} 
\eeq
with $\delta_k = \frac{\kappa_k \Delta t}{\Delta zw_k}$.
At $k=1$, at the bottom we have
\beq
 A_k E_{k-1}^n +  B_k E_k^n + C_k E_{k+1}^n  = E_k^{n-1}   + P_k \Delta t- F_b \Delta t/  \Delta zt_{k} 
 \\ C_k =- \frac{\delta_k}{ \Delta zt_{k}} 
 ~,~ B_k =  1 + I_k\Delta t  +\frac{\delta_k}{\Delta zt_{k}} 
 ~,~ A_k = 0 
\eeq
$F_b$ is the flux of $E$ at $zw_0=-h$.
At $k=N$, at the surface, we have 
\beq
 A_k E_{k-1}^n +  B_k E_k^n + C_k E_{k+1}^n  = E_k^{n-1}   + P_k \Delta t+  F_s \frac{ \Delta t}{ \Delta zt_{k}}  
 \\ C_k =0 ~,~
  B_k =  1 +  I_k\Delta t 
 + \frac{\delta_{k-1}}{ \Delta zt_{k}} 
 ~,~ A_k = - \frac{\delta_{k-1}}{ \Delta zt_{k}} 
\eeq
$F_s$ is the flux of $E$ at $zw_N=0$. 




\section*{Acknowledgments}

The conjugate gradient solvers are taken from GFDL MOM-2 and MOM-3, although modified.
The same holds for some auxilliary routines.



{\small
\bibliography{/Users/ceden/TeX/mybib}
\bibliographystyle{/Users/ceden/TeX/amseng} }


\end{document}
